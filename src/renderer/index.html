<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Copilot Bar</title>
    <style>
      :root {
        /* Dark theme (default) */
        --bg-primary: #1a1a1a;
        --bg-secondary: #252525;
        --bg-tertiary: #2a2a2a;
        --bg-input: #252525;
        --border-color: #333;
        --text-primary: #e0e0e0;
        --text-secondary: #888;
        --text-muted: #666;
        --accent-color: #0066ff;
        --accent-hover: #0052cc;
        --user-message-bg: #0066ff;
        --user-message-text: white;
        --assistant-message-bg: #2a2a2a;
        --code-bg: #1a1a1a;
        --error-bg: #4a1c1c;
        --error-text: #ff6b6b;
        --tool-bg: #2a2a1a;
        --tool-text: #f0a020;
        --tool-complete-bg: #1a2a1a;
        --tool-complete-text: #40a040;
      }

      [data-theme="light"] {
        --bg-primary: #ffffff;
        --bg-secondary: #f5f5f5;
        --bg-tertiary: #ebebeb;
        --bg-input: #ffffff;
        --border-color: #ddd;
        --text-primary: #1a1a1a;
        --text-secondary: #666;
        --text-muted: #999;
        --accent-color: #0066ff;
        --accent-hover: #0052cc;
        --user-message-bg: #0066ff;
        --user-message-text: white;
        --assistant-message-bg: #f0f0f0;
        --code-bg: #e8e8e8;
        --error-bg: #ffe0e0;
        --error-text: #cc0000;
        --tool-bg: #fff8e0;
        --tool-text: #996600;
        --tool-complete-bg: #e0ffe0;
        --tool-complete-text: #006600;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        padding: 12px 16px 10px 16px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        min-width: 0;
      }

      .header-meta {
        justify-content: flex-start;
        gap: 8px;
        flex-wrap: nowrap;
      }

      .header-title {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 0;
      }

      .header h1 {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
      }

      .header h1 svg {
        width: 18px;
        height: 18px;
        fill: var(--text-primary);
      }

      .pill {
        font-size: 10px;
        padding: 5px 10px;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border: 1px solid transparent;
        border-radius: 999px;
        font-weight: 500;
        max-width: 210px;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      button.pill {
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .pill-label {
        display: block;
        flex: 1 1 auto;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .pill-caret {
        flex: 0 0 auto;
        color: var(--text-secondary);
        font-size: 10px;
      }

      button.pill:hover {
        color: var(--text-primary);
        background: var(--bg-secondary);
      }

      #sessionBadge {
        background: var(--bg-secondary);
        border-color: var(--border-color);
        color: var(--text-primary);
        flex: 1 1 auto;
      }

      #modelBadge {
        background: var(--bg-tertiary);
        border-color: transparent;
        color: var(--text-secondary);
        transition: background 0.3s, color 0.3s;
      }

      #modelBadge.verified {
        background: rgba(46, 160, 67, 0.15);
        color: #3fb950;
      }

      #modelBadge.mismatch {
        background: rgba(210, 153, 34, 0.15);
        color: #d29922;
      }

      .header-actions {
        display: flex;
        gap: 4px;
      }

      .config-btn {
        background: transparent;
        border: 1px solid transparent;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 14px;
        width: 30px;
        height: 30px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
      }

      .config-btn:hover {
        color: var(--text-primary);
        background: var(--bg-tertiary);
        border-color: var(--border-color);
      }

      .chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .message {
        padding: 10px 14px;
        border-radius: 12px;
        max-width: 85%;
        font-size: 13px;
        line-height: 1.5;
        word-wrap: break-word;
      }

      .message.user {
        background: var(--user-message-bg);
        color: var(--user-message-text);
        align-self: flex-end;
        border-bottom-right-radius: 4px;
        white-space: pre-wrap;
      }

      .message.assistant {
        background: var(--assistant-message-bg);
        color: var(--text-primary);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
      }

      /* Markdown styles for assistant messages */
      .message.assistant p {
        margin: 0 0 8px 0;
      }

      .message.assistant p:last-child {
        margin-bottom: 0;
      }

      .message.assistant code {
        background: var(--code-bg);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: "SF Mono", "Monaco", "Menlo", monospace;
        font-size: 12px;
      }

      .message.assistant pre {
        background: var(--code-bg);
        padding: 12px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 8px 0;
      }

      .message.assistant pre code {
        background: none;
        padding: 0;
        font-size: 11px;
        line-height: 1.4;
      }

      .message.assistant ul,
      .message.assistant ol {
        margin: 8px 0;
        padding-left: 20px;
      }

      .message.assistant li {
        margin: 4px 0;
      }

      .message.assistant h1,
      .message.assistant h2,
      .message.assistant h3 {
        margin: 12px 0 8px 0;
        color: var(--text-primary);
      }

      .message.assistant h1 { font-size: 16px; }
      .message.assistant h2 { font-size: 14px; }
      .message.assistant h3 { font-size: 13px; }

      .message.assistant blockquote {
        border-left: 3px solid var(--border-color);
        padding-left: 12px;
        margin: 8px 0;
        color: var(--text-secondary);
      }

      .message.assistant a {
        color: #4da6ff;
        text-decoration: none;
      }

      .message.assistant a:hover {
        text-decoration: underline;
      }

      .message.assistant strong {
        color: var(--text-primary);
      }

      .message.assistant table {
        border-collapse: collapse;
        margin: 8px 0;
        font-size: 12px;
        width: 100%;
        display: block;
        overflow-x: auto;
      }

      .message.assistant th,
      .message.assistant td {
        border: 1px solid var(--border-color);
        padding: 6px 10px;
        white-space: nowrap;
      }

      .message.assistant th {
        background: var(--bg-tertiary);
        font-weight: 600;
      }

      .message.assistant tr:hover td {
        background: var(--bg-tertiary);
      }

      /* Syntax highlighting (GitHub dark theme) */
      .hljs-keyword,
      .hljs-selector-tag,
      .hljs-built_in { color: #ff7b72; }
      .hljs-string,
      .hljs-attr { color: #a5d6ff; }
      .hljs-number,
      .hljs-literal { color: #79c0ff; }
      .hljs-comment { color: #8b949e; }
      .hljs-function,
      .hljs-title { color: #d2a8ff; }
      .hljs-variable,
      .hljs-params { color: #ffa657; }
      .hljs-type,
      .hljs-class { color: #7ee787; }

      /* Light theme syntax highlighting */
      [data-theme="light"] .hljs-keyword,
      [data-theme="light"] .hljs-selector-tag,
      [data-theme="light"] .hljs-built_in { color: #d73a49; }
      [data-theme="light"] .hljs-string,
      [data-theme="light"] .hljs-attr { color: #032f62; }
      [data-theme="light"] .hljs-number,
      [data-theme="light"] .hljs-literal { color: #005cc5; }
      [data-theme="light"] .hljs-comment { color: #6a737d; }
      [data-theme="light"] .hljs-function,
      [data-theme="light"] .hljs-title { color: #6f42c1; }
      [data-theme="light"] .hljs-variable,
      [data-theme="light"] .hljs-params { color: #e36209; }
      [data-theme="light"] .hljs-type,
      [data-theme="light"] .hljs-class { color: #22863a; }

      .message.error {
        background: var(--error-bg);
        color: var(--error-text);
      }

      .empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        text-align: center;
        padding: 20px;
      }

      .empty-state svg {
        width: 48px;
        height: 48px;
        fill: var(--border-color);
        margin-bottom: 12px;
      }

      .empty-state p {
        font-size: 13px;
      }

      .input-wrapper {
        border-top: 1px solid var(--border-color);
        padding: 12px 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex-shrink: 0;
      }

      .input-area {
        display: flex;
        gap: 8px;
        align-items: flex-end;
      }

      .input-stack {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
        position: relative;
      }

      .command-hint {
        display: none;
        position: absolute;
        left: 0;
        right: 0;
        bottom: calc(100% + 6px);
        border: 1px solid var(--border-color);
        background: var(--bg-secondary);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      }

      .command-hint-header {
        padding: 8px 10px;
        font-size: 11px;
        color: var(--text-secondary);
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-tertiary);
      }

      .command-hint-item {
        width: 100%;
        text-align: left;
        border: none;
        background: transparent;
        padding: 8px 10px;
        cursor: pointer;
        color: var(--text-primary);
        font-size: 12px;
        display: flex;
        gap: 8px;
        align-items: baseline;
      }

      .command-hint-item:hover {
        background: var(--bg-tertiary);
      }

      .command-hint-item code {
        font-family: "SF Mono", "Monaco", "Menlo", monospace;
        font-size: 12px;
        color: var(--accent-color);
      }

      .command-hint-desc {
        color: var(--text-secondary);
        font-size: 11px;
      }

      textarea {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-input);
        color: var(--text-primary);
        font-size: 13px;
        resize: none;
        font-family: inherit;
        min-height: 40px;
        max-height: 120px;
      }

      textarea:focus {
        outline: none;
        border-color: var(--accent-color);
      }

      textarea::placeholder {
        color: var(--text-muted);
      }

      .send-btn {
        padding: 10px 16px;
        background: var(--accent-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        height: 40px;
        align-self: flex-end;
      }

      .send-btn:hover {
        background: var(--accent-hover);
      }

      .send-btn:disabled {
        background: var(--bg-tertiary);
        color: var(--text-muted);
        cursor: not-allowed;
      }

      .loading {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid #fff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 12px 14px;
      }

      .typing-indicator span {
        width: 6px;
        height: 6px;
        background: var(--text-muted);
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
      }

      .typing-indicator span:nth-child(1) {
        animation-delay: -0.32s;
      }

      .typing-indicator span:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      /* Screenshot thumbnail in chat */
      .screenshot-container {
        margin: 4px 0;
        max-width: 100%;
      }

      .screenshot-container img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        cursor: pointer;
        transition: opacity 0.15s;
        object-fit: contain;
        display: block;
      }

      .screenshot-container img:hover {
        opacity: 0.85;
      }

      .screenshot-caption {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 4px;
      }

      /* Full-size screenshot overlay */
      .screenshot-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        cursor: zoom-out;
      }

      .screenshot-overlay img {
        max-width: 95%;
        max-height: 95%;
        border-radius: 4px;
        object-fit: contain;
      }

      /* Document attachment preview */
      .document-preview {
        margin: 0;
        padding: 8px 10px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        max-width: 100%;
        overflow: hidden;
      }

      .document-preview-icon {
        font-size: 18px;
        flex-shrink: 0;
      }

      .document-preview-info {
        flex: 1;
        min-width: 0;
      }

      .document-preview-name {
        font-size: 12px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .document-preview-meta {
        font-size: 10px;
        color: var(--text-secondary);
      }

      .document-preview-remove {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 16px;
        padding: 4px;
      }

      .document-preview-remove:hover {
        color: var(--error-text);
      }

      .tool-activity {
        font-size: 11px;
        color: var(--tool-text);
        padding: 6px 14px;
        background: var(--tool-bg);
        border-radius: 8px;
        margin: 4px 0;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .tool-activity .tool-icon {
        font-size: 12px;
      }

      .tool-activity.complete {
        color: var(--tool-complete-text);
        background: var(--tool-complete-bg);
      }

      /* Widget Styles */
      .widget {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
        margin: 8px 0;
        max-width: 280px;
      }

      .widget-header {
        font-size: 11px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .widget-display {
        font-size: 42px;
        font-family: "SF Mono", "Monaco", "Menlo", monospace;
        color: var(--text-primary);
        text-align: center;
        margin: 16px 0;
        font-weight: 300;
      }

      .widget-display.done {
        color: #40c040;
      }

      .widget-status {
        font-size: 11px;
        color: var(--text-secondary);
        text-align: center;
        margin-bottom: 12px;
      }

      .widget-controls {
        display: flex;
        gap: 8px;
        justify-content: center;
      }

      .widget-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        cursor: pointer;
        font-size: 12px;
        transition: background 0.15s;
      }

      .widget-btn:hover {
        background: var(--border-color);
      }

      .widget-btn.primary {
        background: var(--accent-color);
        color: white;
      }

      .widget-btn.primary:hover {
        background: var(--accent-hover);
      }

      .widget-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Unit Converter Widget */
      .converter-row {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        align-items: center;
      }

      .converter-input {
        flex: 1;
        padding: 8px 10px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--code-bg);
        color: var(--text-primary);
        font-size: 14px;
        font-family: "SF Mono", monospace;
      }

      .converter-input:focus {
        outline: none;
        border-color: var(--accent-color);
      }

      .converter-select {
        padding: 8px 10px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--code-bg);
        color: var(--text-primary);
        font-size: 12px;
        min-width: 100px;
      }

      .converter-select:focus {
        outline: none;
        border-color: var(--accent-color);
      }

      .converter-arrow {
        color: var(--text-muted);
        font-size: 16px;
      }

      .converter-result {
        font-size: 18px;
        font-family: "SF Mono", monospace;
        color: var(--accent-color);
        text-align: center;
        padding: 8px;
        background: var(--code-bg);
        border-radius: 6px;
        margin-top: 8px;
      }

      .converter-tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }

      .converter-tab {
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        font-size: 10px;
        cursor: pointer;
        text-transform: uppercase;
      }

      .converter-tab:hover {
        background: var(--border-color);
        color: var(--text-primary);
      }

      .converter-tab.active {
        background: var(--accent-color);
        color: white;
      }

      /* World Clock Widget */
      .worldclock-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .worldclock-city {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--border-color);
      }

      .worldclock-city:last-child {
        border-bottom: none;
      }

      .worldclock-city-name {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .worldclock-city-time {
        font-size: 18px;
        font-family: "SF Mono", "Monaco", "Menlo", monospace;
        color: var(--text-primary);
      }

      .worldclock-city-date {
        font-size: 10px;
        color: var(--text-muted);
        text-align: right;
      }

      /* WiFi Widget */
      .wifi-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px;
        background: var(--code-bg);
        border-radius: 8px;
        margin-bottom: 12px;
      }

      .wifi-status-icon {
        font-size: 24px;
      }

      .wifi-status-info {
        flex: 1;
      }

      .wifi-status-label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
      }

      .wifi-status-network {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
      }

      .wifi-status-badge {
        font-size: 10px;
        padding: 3px 8px;
        border-radius: 10px;
        font-weight: 500;
      }

      .wifi-status-badge.connected {
        background: #1a3a1a;
        color: #40c040;
      }

      .wifi-status-badge.disconnected {
        background: #3a2a1a;
        color: #f0a020;
      }

      .wifi-status-badge.off {
        background: #3a1a1a;
        color: #ff6b6b;
      }

      [data-theme="light"] .wifi-status-badge.connected {
        background: #e0ffe0;
        color: #006600;
      }

      [data-theme="light"] .wifi-status-badge.disconnected {
        background: #fff0e0;
        color: #996600;
      }

      [data-theme="light"] .wifi-status-badge.off {
        background: #ffe0e0;
        color: #cc0000;
      }

      .wifi-networks-list {
        max-height: 150px;
        overflow-y: auto;
      }

      .wifi-network-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 0;
        border-bottom: 1px solid var(--border-color);
        font-size: 12px;
      }

      .wifi-network-item:last-child {
        border-bottom: none;
      }

      .wifi-network-item.current {
        color: var(--accent-color);
        font-weight: 500;
      }

      .wifi-network-icon {
        font-size: 14px;
      }

      /* Chart Widget */
      .chart-widget {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
        margin: 8px 0;
        max-width: 360px;
      }

      .chart-widget-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 12px;
        text-align: center;
      }

      .chart-widget-canvas-container {
        position: relative;
        height: 250px;
        width: 100%;
      }

      .chart-widget-fallback {
        font-size: 11px;
        color: var(--text-muted);
        text-align: center;
        padding: 20px;
        background: var(--code-bg);
        border-radius: 8px;
      }

      .chart-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        margin-top: 8px;
      }

      .chart-table th,
      .chart-table td {
        padding: 8px 12px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
      }

      .chart-table th {
        background: var(--bg-tertiary);
        font-weight: 600;
        color: var(--text-primary);
      }

      .chart-table td {
        color: var(--text-secondary);
      }

      .chart-table tr:hover td {
        background: var(--bg-tertiary);
      }

      /* Settings Panel */
      .settings-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }

      .settings-panel {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        width: 340px;
        max-width: 90%;
      }

      .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .settings-header h2 {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .settings-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 20px;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
      }

      .settings-close:hover {
        color: var(--text-primary);
        background: var(--bg-tertiary);
      }

      .settings-row {
        margin-bottom: 16px;
      }

      .settings-row label {
        display: block;
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 6px;
      }

      .settings-row input,
      .settings-row select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--code-bg);
        color: var(--text-primary);
        font-size: 13px;
        font-family: inherit;
      }

      .settings-row input:focus,
      .settings-row select:focus {
        outline: none;
        border-color: var(--accent-color);
      }

      .settings-hint {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 4px;
      }

      .settings-row .shortcut-display {
        font-family: "SF Mono", monospace;
        background: var(--code-bg);
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        color: var(--accent-color);
        display: inline-block;
      }

      .settings-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      .settings-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
      }

      .settings-btn.secondary {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }

      .settings-btn.secondary:hover {
        background: var(--border-color);
      }

      .settings-btn.primary {
        background: var(--accent-color);
        color: white;
      }

      .settings-btn.primary:hover {
        background: var(--accent-hover);
      }

      /* Theme Toggle */
      .theme-toggle {
        display: flex;
        gap: 8px;
      }

      .theme-option {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--code-bg);
        color: var(--text-primary);
        font-size: 12px;
        cursor: pointer;
        text-align: center;
        transition: all 0.15s;
      }

      .theme-option:hover {
        border-color: var(--accent-color);
      }

      .theme-option.active {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
      }

      /* Sessions Panel */
      .sessions-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }

      .sessions-panel {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
        width: 360px;
        max-width: 92%;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .sessions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .sessions-header h2 {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .sessions-actions {
        display: flex;
        gap: 8px;
        justify-content: space-between;
        align-items: center;
      }

      .sessions-btn {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 12px;
        cursor: pointer;
      }

      .sessions-btn.primary {
        background: var(--accent-color);
        border-color: var(--accent-color);
        color: white;
      }

      .sessions-btn.primary:hover {
        background: var(--accent-hover);
        border-color: var(--accent-hover);
      }

      .sessions-btn:hover {
        background: var(--border-color);
      }

      .sessions-list {
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .session-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        background: var(--bg-primary);
      }

      .session-item.active {
        border-color: var(--accent-color);
      }

      .session-item-main {
        flex: 1;
        min-width: 0;
        cursor: pointer;
      }

      .session-item-title {
        font-size: 12px;
        color: var(--text-primary);
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .session-item-meta {
        font-size: 10px;
        color: var(--text-secondary);
        margin-top: 2px;
      }

      .session-item-actions {
        display: flex;
        gap: 6px;
      }

      .session-icon-btn {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        width: 28px;
        height: 28px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .session-icon-btn:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }

      /* Simple modal (used for rename, etc.) */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 110;
      }

      .modal-panel {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
        width: 320px;
        max-width: 92%;
      }

      .modal-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 10px;
      }

      .modal-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 13px;
        font-family: inherit;
        outline: none;
      }

      .modal-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 12px;
      }

      .modal-btn {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 12px;
        cursor: pointer;
      }

      .modal-btn.primary {
        background: var(--accent-color);
        border-color: var(--accent-color);
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-row">
        <div class="header-title">
          <h1>
            <svg viewBox="0 0 512 416" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M181.33 266.143c0-11.497 9.32-20.818 20.818-20.818 11.498 0 20.819 9.321 20.819 20.818v38.373c0 11.497-9.321 20.818-20.819 20.818-11.497 0-20.818-9.32-20.818-20.818v-38.373zM308.807 245.325c-11.477 0-20.798 9.321-20.798 20.818v38.373c0 11.497 9.32 20.818 20.798 20.818 11.497 0 20.818-9.32 20.818-20.818v-38.373c0-11.497-9.32-20.818-20.818-20.818z"
              />
              <path
                d="M512.002 246.393v57.384c-.02 7.411-3.696 14.638-9.67 19.011C431.767 374.444 344.695 416 256 416c-98.138 0-196.379-56.542-246.33-93.21-5.975-4.374-9.65-11.6-9.671-19.012v-57.384a35.347 35.347 0 016.857-20.922l15.583-21.085c8.336-11.312 20.757-14.31 33.98-14.31 4.988-56.953 16.794-97.604 45.024-127.354C155.194 5.77 226.56 0 256 0c29.441 0 100.807 5.77 154.557 62.722 28.19 29.75 40.036 70.401 45.025 127.354 13.263 0 25.602 2.936 33.958 14.31l15.583 21.127c4.476 6.077 6.878 13.345 6.878 20.88zm-97.666-26.075c-.677-13.058-11.292-18.19-22.338-21.824-11.64 7.309-25.848 10.183-39.46 10.183-14.454 0-41.432-3.47-63.872-25.869-5.667-5.625-9.527-14.454-12.155-24.247a212.902 212.902 0 00-20.469-1.088c-6.098 0-13.099.349-20.551 1.088-2.628 9.793-6.509 18.622-12.155 24.247-22.4 22.4-49.418 25.87-63.872 25.87-13.612 0-27.86-2.855-39.501-10.184-11.005 3.613-21.558 8.828-22.277 21.824-1.17 24.555-1.272 49.11-1.375 73.645-.041 12.318-.082 24.658-.288 36.976.062 7.166 4.374 13.818 10.882 16.774 52.97 24.124 103.045 36.278 149.137 36.278 46.01 0 96.085-12.154 149.014-36.278 6.508-2.956 10.84-9.608 10.881-16.774.637-36.832.124-73.809-1.642-110.62h.041z"
              />
            </svg>
            Copilot Bar
          </h1>
        </div>
        <div class="header-actions">
          <button class="config-btn" id="screenshotBtn" title="Capture screenshot">üì∑</button>
          <button class="config-btn" id="documentBtn" title="Attach document">üìé</button>
          <button class="config-btn" id="clearBtn" title="Clear chat">üóëÔ∏è</button>
          <button class="config-btn" id="configBtn" title="Settings">‚öôÔ∏è</button>
          <button class="config-btn" id="quitBtn" title="Quit app">‚úï</button>
        </div>
      </div>
      <div class="header-row header-meta">
        <button class="pill" id="sessionBadge" type="button" title="Sessions">
          <span class="pill-label" id="sessionBadgeLabel">Sessions</span>
          <span class="pill-caret" aria-hidden="true">‚ñæ</span>
        </button>
        <span class="pill" id="modelBadge">loading...</span>
      </div>
    </div>

    <div class="chat-container" id="chatContainer">
      <div class="empty-state" id="emptyState">
        <svg viewBox="0 0 512 416" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M181.33 266.143c0-11.497 9.32-20.818 20.818-20.818 11.498 0 20.819 9.321 20.819 20.818v38.373c0 11.497-9.321 20.818-20.819 20.818-11.497 0-20.818-9.32-20.818-20.818v-38.373zM308.807 245.325c-11.477 0-20.798 9.321-20.798 20.818v38.373c0 11.497 9.32 20.818 20.798 20.818 11.497 0 20.818-9.32 20.818-20.818v-38.373c0-11.497-9.32-20.818-20.818-20.818z"
          />
          <path
            d="M512.002 246.393v57.384c-.02 7.411-3.696 14.638-9.67 19.011C431.767 374.444 344.695 416 256 416c-98.138 0-196.379-56.542-246.33-93.21-5.975-4.374-9.65-11.6-9.671-19.012v-57.384a35.347 35.347 0 016.857-20.922l15.583-21.085c8.336-11.312 20.757-14.31 33.98-14.31 4.988-56.953 16.794-97.604 45.024-127.354C155.194 5.77 226.56 0 256 0c29.441 0 100.807 5.77 154.557 62.722 28.19 29.75 40.036 70.401 45.025 127.354 13.263 0 25.602 2.936 33.958 14.31l15.583 21.127c4.476 6.077 6.878 13.345 6.878 20.88zm-97.666-26.075c-.677-13.058-11.292-18.19-22.338-21.824-11.64 7.309-25.848 10.183-39.46 10.183-14.454 0-41.432-3.47-63.872-25.869-5.667-5.625-9.527-14.454-12.155-24.247a212.902 212.902 0 00-20.469-1.088c-6.098 0-13.099.349-20.551 1.088-2.628 9.793-6.509 18.622-12.155 24.247-22.4 22.4-49.418 25.87-63.872 25.87-13.612 0-27.86-2.855-39.501-10.184-11.005 3.613-21.558 8.828-22.277 21.824-1.17 24.555-1.272 49.11-1.375 73.645-.041 12.318-.082 24.658-.288 36.976.062 7.166 4.374 13.818 10.882 16.774 52.97 24.124 103.045 36.278 149.137 36.278 46.01 0 96.085-12.154 149.014-36.278 6.508-2.956 10.84-9.608 10.881-16.774.637-36.832.124-73.809-1.642-110.62h.041z"
          />
        </svg>
        <p>Ask me anything</p>
      </div>
    </div>

    <div class="input-wrapper">
      <div class="attachment-area" id="attachmentArea" style="display: none;"></div>
      <div class="input-area">
        <div class="input-stack">
          <textarea
            id="input"
            placeholder="Ask Copilot... (try /help)"
            rows="1"
            autofocus
          ></textarea>
          <div class="command-hint" id="commandHint"></div>
        </div>
        <button class="send-btn" id="sendBtn" disabled>Send</button>
      </div>
    </div>

    <script>
      const { ipcRenderer } = require("electron");

      // Markdown rendering
      let marked = {
        parse: (text) =>
          text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/\n/g, "<br>"),
      };
      let hljs = null;
      let Chart = null;
      let markdownInitPromise = null;
      let chartInitPromise = null;

      async function initChartJs() {
        if (Chart) return Chart;
        if (chartInitPromise) return chartInitPromise;

        chartInitPromise = (async () => {
          try {
            const { pathToFileURL } = require("node:url");
            const chartPath = require.resolve("chart.js");
            const chartModule = await import(pathToFileURL(chartPath).href);
            Chart = chartModule.Chart || chartModule.default || chartModule;
            return Chart;
          } catch (e) {
            console.warn("[Chart] Failed to load Chart.js:", e);
            return null;
          }
        })();

        return chartInitPromise;
      }

      async function initMarkdown() {
        try {
          const { pathToFileURL } = require("node:url");

          const markedPath = require.resolve("marked");
          const hljsPath = require.resolve("highlight.js");

          const markedModule = await import(pathToFileURL(markedPath).href);
          const hljsModule = await import(pathToFileURL(hljsPath).href);

          const markedFn = markedModule.marked ?? markedModule.default ?? markedModule;
          const hljsLib = hljsModule.default ?? hljsModule;

          if (typeof markedFn?.setOptions === "function") {
            markedFn.setOptions({
              highlight: function (code, lang) {
                if (hljsLib && lang && typeof hljsLib.getLanguage === "function" && hljsLib.getLanguage(lang)) {
                  try {
                    return hljsLib.highlight(code, { language: lang }).value;
                  } catch (e) {}
                }
                if (hljsLib && typeof hljsLib.highlightAuto === "function") {
                  return hljsLib.highlightAuto(code).value;
                }
                return code;
              },
              breaks: true,
              gfm: true,
            });
          }

          marked = markedFn;
          hljs = hljsLib;
          console.log("Markdown libraries loaded");
        } catch (err) {
          console.error("Failed to load markdown libraries:", err);
        }
      }

      const input = document.getElementById("input");
      const sendBtn = document.getElementById("sendBtn");
      const chatContainer = document.getElementById("chatContainer");
      let emptyState = document.getElementById("emptyState");
      const commandHint = document.getElementById("commandHint");
      const configBtn = document.getElementById("configBtn");
      const clearBtn = document.getElementById("clearBtn");
      const quitBtn = document.getElementById("quitBtn");
      const screenshotBtn = document.getElementById("screenshotBtn");
      const modelBadge = document.getElementById("modelBadge");
      const sessionBadge = document.getElementById("sessionBadge");
      const sessionBadgeLabel = document.getElementById("sessionBadgeLabel");

      let isLoading = false;
      let activeSession = { id: null, title: "Chat" };

      // Load and display current model + theme
      async function loadConfig() {
        try {
          const config = await ipcRenderer.invoke("get-config");
          modelBadge.textContent = config.model || "unknown";
          // Apply saved theme
          applyTheme(config.theme || "dark");
        } catch (err) {
          modelBadge.textContent = "error";
        }
      }

      // Theme handling
      function applyTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
      }

      // Load chat history on startup
      async function loadChatHistory() {
        try {
          const history = await ipcRenderer.invoke("get-chat-history", activeSession.id || undefined, 100);
          if (history && history.length > 0) {
            // Remove empty state
            if (emptyState) {
              emptyState.remove();
              emptyState = null;
            }
            // Restore messages
            history.forEach((msg) => {
              addMessage(msg.content, msg.role, false); // false = don't persist again
            });
          }
        } catch (err) {
          console.error("Failed to load chat history:", err);
        }
      }

      function renderEmptyState() {
        chatContainer.innerHTML = `
          <div class="empty-state" id="emptyState">
            <svg viewBox="0 0 512 416" xmlns="http://www.w3.org/2000/svg">
              <path d="M181.33 266.143c0-11.497 9.32-20.818 20.818-20.818 11.498 0 20.819 9.321 20.819 20.818v38.373c0 11.497-9.321 20.818-20.819 20.818-11.497 0-20.818-9.32-20.818-20.818v-38.373zM308.807 245.325c-11.477 0-20.798 9.321-20.798 20.818v38.373c0 11.497 9.32 20.818 20.798 20.818 11.497 0 20.818-9.32 20.818-20.818v-38.373c0-11.497-9.32-20.818-20.818-20.818z" />
              <path d="M512.002 246.393v57.384c-.02 7.411-3.696 14.638-9.67 19.011C431.767 374.444 344.695 416 256 416c-98.138 0-196.379-56.542-246.33-93.21-5.975-4.374-9.65-11.6-9.671-19.012v-57.384a35.347 35.347 0 016.857-20.922l15.583-21.085c8.336-11.312 20.757-14.31 33.98-14.31 4.988-56.953 16.794-97.604 45.024-127.354C155.194 5.77 226.56 0 256 0c29.441 0 100.807 5.77 154.557 62.722 28.19 29.75 40.036 70.401 45.025 127.354 13.263 0 25.602 2.936 33.958 14.31l15.583 21.127c4.476 6.077 6.878 13.345 6.878 20.88zm-97.666-26.075c-.677-13.058-11.292-18.19-22.338-21.824-11.64 7.309-25.848 10.183-39.46 10.183-14.454 0-41.432-3.47-63.872-25.869-5.667-5.625-9.527-14.454-12.155-24.247a212.902 212.902 0 00-20.469-1.088c-6.098 0-13.099.349-20.551 1.088-2.628 9.793-6.509 18.622-12.155 24.247-22.4 22.4-49.418 25.87-63.872 25.87-13.612 0-27.86-2.855-39.501-10.184-11.005 3.613-21.558 8.828-22.277 21.824-1.17 24.555-1.272 49.11-1.375 73.645-.041 12.318-.082 24.658-.288 36.976.062 7.166 4.374 13.818 10.882 16.774 52.97 24.124 103.045 36.278 149.137 36.278 46.01 0 96.085-12.154 149.014-36.278 6.508-2.956 10.84-9.608 10.881-16.774.637-36.832.124-73.809-1.642-110.62h.041z" />
            </svg>
            <p>Ask me anything</p>
          </div>
        `;
        emptyState = document.getElementById("emptyState");
      }

      function setSessionBadge(title) {
        const t = (title && String(title).trim()) ? String(title).trim() : "";
        const label = t ? `Sessions ¬∑ ${t}` : "Sessions";
        sessionBadgeLabel.textContent = label;
        sessionBadge.title = t ? `Sessions: ${t}` : "Sessions";
      }

      function escapeHtml(unsafe) {
        return String(unsafe ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function openTextModal({ title, initialValue, placeholder, confirmText }) {
        return new Promise((resolve) => {
          const overlay = document.createElement("div");
          overlay.className = "modal-overlay";
          overlay.tabIndex = -1;
          overlay.innerHTML = `
            <div class="modal-panel">
              <div class="modal-title">${escapeHtml(title)}</div>
              <input class="modal-input" id="modalInput" type="text" />
              <div class="modal-actions">
                <button class="modal-btn" id="modalCancel" type="button">Cancel</button>
                <button class="modal-btn primary" id="modalConfirm" type="button">${escapeHtml(confirmText || "Save")}</button>
              </div>
            </div>
          `;
          document.body.appendChild(overlay);

          const inputEl = overlay.querySelector("#modalInput");
          const cancelBtn = overlay.querySelector("#modalCancel");
          const confirmBtn = overlay.querySelector("#modalConfirm");

          inputEl.value = initialValue || "";
          inputEl.placeholder = placeholder || "";
          inputEl.focus();
          inputEl.select();

          const close = (value) => {
            overlay.remove();
            resolve(value);
          };

          cancelBtn.onclick = () => close(null);
          overlay.onclick = (e) => {
            if (e.target === overlay) close(null);
          };
          confirmBtn.onclick = () => close(inputEl.value);
          overlay.addEventListener("keydown", (e) => {
            if (e.key === "Escape") close(null);
            if (e.key === "Enter") close(inputEl.value);
          });
        });
      }

      async function bootstrap() {
        input.disabled = true;
        sendBtn.disabled = true;

        markdownInitPromise = initMarkdown();
        await markdownInitPromise;
        await loadConfig();
        try {
          activeSession = await ipcRenderer.invoke("get-active-session");
          setSessionBadge(activeSession.title);
        } catch (e) {
          // ignore
        }
        await loadChatHistory();

        input.disabled = false;
        updateSendBtn();
        input.focus();
      }

      // --- Screenshot helpers ---
      const SCREENSHOT_PREFIX_RE = /^\[screenshot:(.+?)\]([\s\S]*)$/;

      function parseScreenshotContent(content) {
        const match = content.match(SCREENSHOT_PREFIX_RE);
        if (!match) return null;
        return { imageSrc: match[1], text: match[2].trim() };
      }

      function getImageSrc(pathOrUrl) {
        if (pathOrUrl.startsWith("http://") || pathOrUrl.startsWith("https://")) {
          return pathOrUrl;
        }
        return `file://${pathOrUrl}`;
      }

      function openScreenshotOverlay(src) {
        const overlay = document.createElement("div");
        overlay.className = "screenshot-overlay";
        const img = document.createElement("img");
        img.src = src;
        overlay.appendChild(img);
        overlay.addEventListener("click", () => overlay.remove());
        const dismiss = (e) => {
          if (e.key === "Escape") { overlay.remove(); document.removeEventListener("keydown", dismiss); }
        };
        document.addEventListener("keydown", dismiss);
        document.body.appendChild(overlay);
      }

      function renderMarkdown(text) {
        try {
          if (typeof marked?.parse === "function") return marked.parse(text);
          if (typeof marked === "function") return marked(text);
        } catch (e) {}
        return null;
      }

      function addMessage(content, type, persist = true) {
        if (emptyState) {
          emptyState.remove();
          emptyState = null;
        }

        const msg = document.createElement("div");
        msg.className = `message ${type}`;

        // Check for screenshot content
        const screenshotData = parseScreenshotContent(content);

        if (screenshotData) {
          const container = document.createElement("div");
          container.className = "screenshot-container";

          const img = document.createElement("img");
          const src = getImageSrc(screenshotData.imageSrc);
          img.src = src;
          img.alt = "Screenshot";
          img.loading = "lazy";
          img.addEventListener("click", () => openScreenshotOverlay(src));
          img.addEventListener("error", () => {
            img.style.display = "none";
            const fallback = document.createElement("div");
            fallback.className = "screenshot-caption";
            fallback.textContent = "Image not found: " + screenshotData.imageSrc;
            container.appendChild(fallback);
          });
          container.appendChild(img);

          if (screenshotData.text) {
            const caption = document.createElement("div");
            caption.className = "screenshot-caption";
            const html = (type === "assistant") ? renderMarkdown(screenshotData.text) : null;
            if (html) { caption.innerHTML = html; } else { caption.textContent = screenshotData.text; }
            container.appendChild(caption);
          }

          msg.appendChild(container);
        } else if (type === "assistant" && marked) {
          // Render markdown for assistant messages
          const html = renderMarkdown(content);
          if (html) { msg.innerHTML = html; } else { msg.textContent = content; }
        } else {
          msg.textContent = content;
        }

        chatContainer.appendChild(msg);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        // Persist to database (unless loading from history)
        if (persist && (type === "user" || type === "assistant" || type === "error")) {
          ipcRenderer.invoke("add-chat-message", type, content, activeSession.id || undefined).catch(console.error);
        }

        return msg;
      }

      function showTypingIndicator() {
        const indicator = document.createElement("div");
        indicator.className = "message assistant typing-indicator";
        indicator.id = "typingIndicator";
        indicator.innerHTML = "<span></span><span></span><span></span>";
        chatContainer.appendChild(indicator);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function hideTypingIndicator() {
        const indicator = document.getElementById("typingIndicator");
        if (indicator) indicator.remove();
      }

      const slashCommands = [
        { command: "/help", description: "Show commands, features, and examples" },
        { command: "/new", description: "Start a new chat session" },
        { command: "/sessions", description: "Open chat sessions" },
        { command: "/rename", description: "Rename current chat (usage: /rename My Chat)" },
        { command: "/switch", description: "Switch chat (usage: /switch 3 or /switch My)" },
        { command: "/compact", description: "Compact conversation (summarize & reset context)" },
      ];

      function renderCommandHint(items) {
        if (!items || items.length === 0) {
          commandHint.style.display = "none";
          commandHint.innerHTML = "";
          return;
        }

        commandHint.style.display = "block";
        commandHint.innerHTML = `
          <div class="command-hint-header">Slash commands (Tab to autocomplete)</div>
          ${items
            .map(
              (c) => `
            <button class="command-hint-item" type="button" data-command="${c.command}">
              <code>${c.command}</code>
              <span class="command-hint-desc">${c.description}</span>
            </button>
          `
            )
            .join("")}
        `;

        commandHint.querySelectorAll("[data-command]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const cmd = btn.getAttribute("data-command");
            if (!cmd) return;
            input.value = cmd;
            input.focus();
            updateCommandHint();
          });
        });
      }

      function updateCommandHint() {
        const value = input.value;
        if (!value.startsWith("/")) {
          renderCommandHint([]);
          return;
        }

        const query = value.slice(1).trim().toLowerCase();
        const matches = slashCommands
          .filter((c) => c.command.slice(1).toLowerCase().startsWith(query))
          .slice(0, 8);
        renderCommandHint(matches.length ? matches : slashCommands);
      }

      function getHelpMarkdown() {
        return `# /help

Copilot Bar is a menu bar chat app that can **chat**, **run tools**, and **show widgets**.

## Slash Commands
- \`/help\` ‚Äî Show commands, features, and examples
- \`/new\` ‚Äî Start a new chat session
- \`/sessions\` ‚Äî Open chat sessions
- \`/rename <title>\` ‚Äî Rename the current chat session
- \`/switch <id|title>\` ‚Äî Switch to another chat session
- \`/compact\` ‚Äî Summarize & compact the conversation to free context space

## Chat & AI
- Ask questions or request help: ‚ÄúExplain this error‚Äù, ‚ÄúSummarize these notes‚Ä¶‚Äù
- Markdown rendering: code blocks and formatting render automatically.
- Chat history persists across sessions.

## System Controls (macOS)
- Volume: "Set volume to 50%", "Mute my computer"
- Brightness (optional): \`brew install brightness\`, then "Set brightness to 80%"
- Do Not Disturb / Focus: "Turn on do not disturb", "Is focus mode enabled?"
- Wi‚ÄëFi: "Turn off WiFi", "What network am I connected to?", "Show my saved networks"
- Bluetooth: "Turn on Bluetooth", "Turn off Bluetooth", "Is Bluetooth on?" (requires \`brew install blueutil\`)
- App launcher: "Open Safari", "Open Terminal"
- Shell: ‚ÄúRun \`ls -la ~/Documents\`‚Äù, ‚ÄúShow disk usage‚Äù

## Widgets & Productivity
- Timers: ‚ÄúStart a timer‚Äù, ‚ÄúSet a 5 minute countdown‚Äù, ‚ÄúStart a Pomodoro‚Äù
- World clock: ‚ÄúWhat time is it in Tokyo?‚Äù, ‚ÄúShow me a world clock‚Äù
- Unit converter: ‚ÄúConvert 100 pounds to kilograms‚Äù, ‚ÄúOpen the temperature converter‚Äù
- Wi‚ÄëFi widget: ‚ÄúShow my saved networks‚Äù

## Screenshot Analysis
- Use the üì∏ button or type: ‚ÄúTake a screenshot‚Äù / ‚ÄúCapture my screen and tell me what you see‚Äù
- If configured, screenshots can be uploaded via S3-compatible storage (\`.env.example\`).

## Reminders
- ‚ÄúRemind me to take a break in 30 minutes‚Äù
- ‚ÄúWhat reminders do I have?‚Äù

## Settings & Shortcuts
- Open settings (‚öôÔ∏è) to change model, theme, and global shortcut.
- Default shortcut: \`Cmd+Shift+T\` (macOS) / \`Ctrl+Shift+T\` (Windows/Linux)
`;
      }

      async function switchToSession(sessionId) {
        const session = await ipcRenderer.invoke("set-active-session", sessionId);
        activeSession = session;
        setSessionBadge(activeSession.title);
        renderEmptyState();
        await loadChatHistory();
      }

      async function createAndSwitchSession(title) {
        const session = await ipcRenderer.invoke("create-session", title);
        activeSession = session;
        setSessionBadge(activeSession.title);
        renderEmptyState();
        await loadChatHistory();
      }

      async function showSessions() {
        const overlay = document.createElement("div");
        overlay.className = "sessions-overlay";
        overlay.tabIndex = -1;
        overlay.innerHTML = `
          <div class="sessions-panel">
            <div class="sessions-header">
              <h2>Chats</h2>
              <button class="settings-close" aria-label="Close">&times;</button>
            </div>
            <div class="sessions-actions">
              <button class="sessions-btn primary" id="newChatBtn">New chat</button>
              <button class="sessions-btn" id="refreshChatsBtn">Refresh</button>
            </div>
            <div class="sessions-list" id="sessionsList"></div>
          </div>
        `;
        document.body.appendChild(overlay);
        overlay.focus();

        const closeBtn = overlay.querySelector(".settings-close");
        const listEl = overlay.querySelector("#sessionsList");
        const newChatBtn = overlay.querySelector("#newChatBtn");
        const refreshBtn = overlay.querySelector("#refreshChatsBtn");

        const close = () => overlay.remove();
        closeBtn.onclick = close;
        overlay.onclick = (e) => {
          if (e.target === overlay) close();
        };

        function formatTimestamp(ts) {
          if (!ts) return "";
          const iso = String(ts).includes("T") ? String(ts) : String(ts).replace(" ", "T");
          const d = new Date(iso);
          if (Number.isNaN(d.getTime())) return String(ts);
          const diff = Date.now() - d.getTime();
          if (diff < 60 * 1000) return "just now";
          if (diff < 60 * 60 * 1000) return `${Math.round(diff / (60 * 1000))}m ago`;
          if (diff < 24 * 60 * 60 * 1000) return `${Math.round(diff / (60 * 60 * 1000))}h ago`;
          return d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
        }

        async function renderList() {
          const sessions = await ipcRenderer.invoke("list-sessions", 50);
          listEl.innerHTML = sessions
            .map((s) => {
              const active = s.id === activeSession.id ? "active" : "";
              const meta = formatTimestamp(s.last_message_at || s.updated_at || s.created_at || "");
              const safeTitle = escapeHtml(s.title || "Chat");
              return `
                <div class="session-item ${active}" data-session-id="${s.id}">
                  <div class="session-item-main" data-action="switch" title="${safeTitle}">
                    <div class="session-item-title">${safeTitle}</div>
                    <div class="session-item-meta">#${s.id}${meta ? " ‚Ä¢ " + meta : ""}</div>
                  </div>
                  <div class="session-item-actions">
                    <button class="session-icon-btn" data-action="rename" title="Rename">‚úé</button>
                    <button class="session-icon-btn" data-action="delete" title="Delete">üóëÔ∏è</button>
                  </div>
                </div>
              `;
            })
            .join("");

          listEl.querySelectorAll("[data-session-id]").forEach((row) => {
            const id = Number.parseInt(row.getAttribute("data-session-id"), 10);
            row.querySelectorAll("[data-action]").forEach((el) => {
              el.addEventListener("click", async (e) => {
                e.preventDefault();
                e.stopPropagation();
                const action = el.getAttribute("data-action");
                if (action === "switch") {
                  await switchToSession(id);
                  close();
                } else if (action === "rename") {
                  const current = row.querySelector(".session-item-title")?.textContent || "Chat";
                  const next = await openTextModal({
                    title: "Rename session",
                    initialValue: current,
                    placeholder: "Session name",
                    confirmText: "Rename",
                  });
                  if (next && next.trim()) {
                    await ipcRenderer.invoke("rename-session", id, next.trim());
                    if (id === activeSession.id) {
                      activeSession.title = next.trim();
                      setSessionBadge(activeSession.title);
                    }
                    await renderList();
                  }
                } else if (action === "delete") {
                  if (confirm("Delete this chat? This will remove its messages.")) {
                    await ipcRenderer.invoke("delete-session", id);
                    activeSession = await ipcRenderer.invoke("get-active-session");
                    setSessionBadge(activeSession.title);
                    renderEmptyState();
                    await loadChatHistory();
                    await renderList();
                  }
                }
              });
            });
          });
        }

        newChatBtn.onclick = async () => {
          await createAndSwitchSession();
          close();
        };
        refreshBtn.onclick = renderList;

        overlay.addEventListener("keydown", (e) => {
          if (e.key === "Escape") close();
        });

        await renderList();
      }

      async function handleSlashCommand(rawPrompt) {
        const trimmed = rawPrompt.trim();
        if (!trimmed.startsWith("/")) return false;

        const parts = trimmed.slice(1).trim().split(/\s+/);
        const command = parts[0]?.toLowerCase();
        const args = parts.slice(1);
        if (!command) {
          addMessage("Available commands: " + slashCommands.map((c) => c.command).join(", ") + "\n\nTry `/help`.", "assistant");
          return true;
        }

        if (command === "help") {
          addMessage(getHelpMarkdown(), "assistant");
          return true;
        }

        if (command === "sessions") {
          showSessions().catch(console.error);
          return true;
        }

        if (command === "new") {
          createAndSwitchSession().catch((e) => addMessage(`Error: ${e.message || e}`, "error"));
          return true;
        }

        if (command === "rename") {
          if (!activeSession.id) {
            addMessage("No active session yet. Try again in a moment.", "error");
            return true;
          }
          const title = args.join(" ").trim();
          if (!title) {
            const next = await openTextModal({
              title: "Rename session",
              initialValue: activeSession.title || "",
              placeholder: "Session name",
              confirmText: "Rename",
            });
            if (next && next.trim()) {
              ipcRenderer.invoke("rename-session", activeSession.id, next.trim()).then(() => {
                activeSession.title = next.trim();
                setSessionBadge(activeSession.title);
              });
            }
            return true;
          }
          ipcRenderer.invoke("rename-session", activeSession.id, title).then(() => {
            activeSession.title = title;
            setSessionBadge(activeSession.title);
          });
          return true;
        }

        if (command === "switch") {
          const target = args.join(" ").trim();
          if (!target) {
            addMessage("Usage: `/switch 3` or `/switch My Chat`", "assistant");
            return true;
          }
          const asId = Number.parseInt(target, 10);
          if (!Number.isNaN(asId) && asId > 0) {
            switchToSession(asId).catch((e) => addMessage(`Error: ${e.message || e}`, "error"));
            return true;
          }
          ipcRenderer.invoke("list-sessions", 50).then((sessions) => {
            const match = sessions.find((s) => (s.title || "").toLowerCase().startsWith(target.toLowerCase()));
            if (!match) {
              addMessage(`No chat found matching "${target}".`, "error");
              return;
            }
            switchToSession(match.id).catch((e) => addMessage(`Error: ${e.message || e}`, "error"));
          });
          return true;
        }

        if (command === "compact") {
          addMessage("Compacting conversation‚Ä¶", "assistant", false);
          showTypingIndicator();
          try {
            const result = await ipcRenderer.invoke("compact-session", activeSession.id || undefined);
            hideTypingIndicator();
            if (result.success) {
              await loadChatHistory();
            } else {
              addMessage(`Compaction failed: ${result.error}`, "error");
            }
          } catch (e) {
            hideTypingIndicator();
            addMessage(`Compaction error: ${e.message}`, "error");
          }
          return true;
        }

        addMessage(`Unknown command: /${command}. Try /help.`, "error");
        return true;
      }

      // --- Streaming state ---
      let streamingBubble = null;
      let streamingMessageId = null;
      let streamedContent = "";

      ipcRenderer.on("chat-delta", (_event, delta) => {
        if (!isLoading) return; // ignore stray deltas

        // New messageId means a new assistant message is starting
        if (delta.messageId !== streamingMessageId) {
          streamingMessageId = delta.messageId;
          streamedContent = "";

          // Replace typing indicator with a streaming bubble
          hideTypingIndicator();

          if (emptyState) { emptyState.remove(); emptyState = null; }
          streamingBubble = document.createElement("div");
          streamingBubble.className = "message assistant";
          chatContainer.appendChild(streamingBubble);
        }

        streamedContent += delta.content;

        // Render progressively as plain text (fast), markdown applied on finalize
        if (streamingBubble) {
          streamingBubble.textContent = streamedContent;
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
      });

      async function sendMessage() {
        const prompt = input.value.trim();
        if (!prompt) return;
        if (isLoading) return;

        // Always hide slash command hint on send
        renderCommandHint([]);

        // Slash commands (handled locally; no Copilot call required)
        if (prompt.startsWith("/")) {
          addMessage(prompt, "user");
          input.value = "";
          input.style.height = "auto";
          await handleSlashCommand(prompt);
          input.focus();
          return;
        }

        isLoading = true;
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<span class="loading"></span>';

        // Reset streaming state
        streamingBubble = null;
        streamingMessageId = null;
        streamedContent = "";

        addMessage(prompt, "user");
        input.value = "";
        input.style.height = "auto";

        showTypingIndicator();

        // Prepare message data with optional attachment
        const messageData = { prompt };

        if (pendingDocument) {
          messageData.attachment = pendingDocument;
          // If no prompt, use a default one
          if (!prompt) {
            messageData.prompt = `Analyze this ${pendingDocument.type} document`;
          }
          // Clear attachment after including it
          clearAttachment();
        }

        try {
          const result = await ipcRenderer.invoke("chat", messageData.prompt, activeSession.id || undefined, messageData.attachment);
          hideTypingIndicator();

          if (result.success) {
            if (streamingBubble) {
              // Finalize: re-render with markdown and persist
              try {
                if (typeof marked?.parse === "function") {
                  streamingBubble.innerHTML = marked.parse(result.result);
                } else if (typeof marked === "function") {
                  streamingBubble.innerHTML = marked(result.result);
                } else {
                  streamingBubble.textContent = result.result;
                }
              } catch (e) {
                streamingBubble.textContent = result.result;
              }
              // Persist to DB
              ipcRenderer.invoke("add-chat-message", "assistant", result.result, activeSession.id || undefined).catch(console.error);
            } else {
              // No streaming deltas arrived ‚Äî fall back to standard message
              addMessage(result.result, "assistant");
            }
          } else {
            if (streamingBubble) streamingBubble.remove();
            addMessage("Error: " + result.error, "error");
          }
        } catch (err) {
          hideTypingIndicator();
          if (streamingBubble) streamingBubble.remove();
          addMessage("Error: " + err.message, "error");
        } finally {
          streamingBubble = null;
          streamingMessageId = null;
          streamedContent = "";
          isLoading = false;
          sendBtn.textContent = "Send";
          updateSendBtn();
          input.focus();
        }
      }

      sendBtn.addEventListener("click", sendMessage);

      input.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          // Close slash command hint (and other transient UI)
          renderCommandHint([]);
          return;
        }

        if (e.key === "Tab" && input.value.startsWith("/")) {
          const query = input.value.slice(1).trim().toLowerCase();
          const first = slashCommands.find((c) => c.command.slice(1).toLowerCase().startsWith(query));
          if (first) {
            e.preventDefault();
            input.value = first.command;
            updateCommandHint();
            return;
          }
        }

        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Auto-resize textarea + toggle send button
      function updateSendBtn() {
        if (!isLoading) {
          sendBtn.disabled = !input.value.trim();
        }
      }

      input.addEventListener("input", () => {
        input.style.height = "auto";
        input.style.height = Math.min(input.scrollHeight, 120) + "px";
        updateCommandHint();
        updateSendBtn();
      });

      // Hide hint when focus is lost
      input.addEventListener("blur", () => {
        setTimeout(() => renderCommandHint([]), 100);
      });

      input.addEventListener("focus", () => {
        updateCommandHint();
      });

      bootstrap();

      // Settings panel
      let currentConfig = {};

      function showSettings() {
        const overlay = document.createElement("div");
        overlay.className = "settings-overlay";
        overlay.innerHTML = `
          <div class="settings-panel">
            <div class="settings-header">
              <h2>Settings</h2>
              <button class="settings-close">&times;</button>
            </div>
            <div class="settings-row">
              <label>Model</label>
              <select id="settingsModel">
                <option value="">Loading models...</option>
              </select>
            </div>
            <div class="settings-row">
              <label>Theme</label>
              <div class="theme-toggle">
                <button class="theme-option ${currentConfig.theme === 'light' ? 'active' : ''}" data-theme="light">‚òÄÔ∏è Light</button>
                <button class="theme-option ${currentConfig.theme !== 'light' ? 'active' : ''}" data-theme="dark">üåô Dark</button>
              </div>
            </div>
            <div class="settings-row">
              <label>Global Shortcut</label>
              <div class="shortcut-display" id="shortcutDisplay">${currentConfig.shortcut || "..."}</div>
              <p class="settings-hint">Press any key combination to change</p>
              <input type="text" id="shortcutInput" placeholder="Press keys..." readonly style="margin-top: 8px;" />
            </div>
            <div class="settings-actions">
              <button class="settings-btn secondary" id="settingsCancel">Cancel</button>
              <button class="settings-btn primary" id="settingsSave">Save</button>
            </div>
          </div>
        `;

        document.body.appendChild(overlay);

        const modelSelect = overlay.querySelector("#settingsModel");
        const shortcutInput = overlay.querySelector("#shortcutInput");
        const shortcutDisplay = overlay.querySelector("#shortcutDisplay");
        const closeBtn = overlay.querySelector(".settings-close");
        const cancelBtn = overlay.querySelector("#settingsCancel");
        const saveBtn = overlay.querySelector("#settingsSave");
        const themeOptions = overlay.querySelectorAll(".theme-option");

        // Populate model dropdown dynamically from SDK
        (async () => {
          try {
            const resp = await ipcRenderer.invoke("list-models");
            if (resp.success && resp.models.length > 0) {
              modelSelect.innerHTML = "";
              for (const m of resp.models) {
                const opt = document.createElement("option");
                opt.value = m.id;
                const state = m.policy?.state;
                const suffix = state === "disabled" ? " (disabled)" : state === "unconfigured" ? " (unconfigured)" : "";
                opt.textContent = (m.name || m.id) + suffix;
                if (state === "disabled") opt.disabled = true;
                modelSelect.appendChild(opt);
              }
            } else {
              // Fallback: keep current model as only option
              modelSelect.innerHTML = `<option value="${currentConfig.model || "gpt-5-mini"}">${currentConfig.model || "gpt-5-mini"}</option>`;
            }
          } catch {
            modelSelect.innerHTML = `<option value="${currentConfig.model || "gpt-5-mini"}">${currentConfig.model || "gpt-5-mini"}</option>`;
          }
          modelSelect.value = currentConfig.model || "gpt-5-mini";
        })();

        // Set current values
        let newShortcut = currentConfig.shortcut;
        let newTheme = currentConfig.theme || "dark";

        // Theme toggle handling
        themeOptions.forEach((btn) => {
          btn.addEventListener("click", () => {
            themeOptions.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            newTheme = btn.dataset.theme;
            // Preview theme immediately
            applyTheme(newTheme);
          });
        });

        // Shortcut recording
        shortcutInput.addEventListener("keydown", (e) => {
          e.preventDefault();
          const parts = [];
          if (e.metaKey || e.ctrlKey) parts.push("CommandOrControl");
          if (e.altKey) parts.push("Alt");
          if (e.shiftKey) parts.push("Shift");

          const key = e.key;
          if (!["Control", "Shift", "Alt", "Meta"].includes(key)) {
            parts.push(key.length === 1 ? key.toUpperCase() : key);
          }

          if (parts.length > 1) {
            newShortcut = parts.join("+");
            shortcutInput.value = newShortcut;
            shortcutDisplay.textContent = newShortcut;
          }
        });

        // Close handlers
        const close = () => {
          // Revert theme if cancelled
          applyTheme(currentConfig.theme || "dark");
          overlay.remove();
        };
        closeBtn.onclick = close;
        cancelBtn.onclick = close;
        overlay.onclick = (e) => {
          if (e.target === overlay) close();
        };

        // Save handler
        saveBtn.onclick = async () => {
          const newModel = modelSelect.value;
          if (newModel !== currentConfig.model) {
            await ipcRenderer.invoke("set-config", "model", newModel);
            currentConfig.model = newModel;
            configuredModel = newModel;
            modelBadge.textContent = newModel;
            modelBadge.className = "pill";
            modelBadge.title = newModel;
          }
          if (newShortcut && newShortcut !== currentConfig.shortcut) {
            await ipcRenderer.invoke("set-config", "shortcut", newShortcut);
            currentConfig.shortcut = newShortcut;
          }
          if (newTheme !== currentConfig.theme) {
            await ipcRenderer.invoke("set-config", "theme", newTheme);
            currentConfig.theme = newTheme;
          }
          applyTheme(newTheme);
          overlay.remove();
        };
      }

      configBtn.addEventListener("click", async () => {
        currentConfig = await ipcRenderer.invoke("get-config");
        showSettings();
      });

      sessionBadge.addEventListener("click", () => {
        showSessions().catch(console.error);
      });

      // Clear chat
      clearBtn.addEventListener("click", async () => {
        if (!confirm("Clear messages in this chat?")) return;
        await ipcRenderer.invoke("clear-chat-history", activeSession.id || undefined);
        renderEmptyState();
        input.focus();
      });

      // Quit app
      quitBtn.addEventListener("click", () => {
        ipcRenderer.invoke("quit-app");
      });

      // Screenshot capture
      screenshotBtn.addEventListener("click", async () => {
        // Remove empty state if present
        if (emptyState && emptyState.parentNode) {
          emptyState.remove();
        }

        const tempMsg = addMessage("Capturing screenshot...", "assistant", false);

        try {
          const result = await ipcRenderer.invoke("capture-screenshot");
          // Remove the temporary "Capturing..." message
          if (tempMsg && tempMsg.parentNode) tempMsg.remove();

          if (result.success) {
            const imageRef = result.url || result.path;
            const label = result.url
              ? "Screenshot captured and uploaded!"
              : "Screenshot saved and copied to clipboard!";
            addMessage(`[screenshot:${imageRef}]${label}`, "assistant");
          } else {
            addMessage(`Screenshot failed: ${result.error}`, "error");
          }
        } catch (err) {
          if (tempMsg && tempMsg.parentNode) tempMsg.remove();
          addMessage(`Screenshot error: ${err.message || "Unknown error"}`, "error");
        }
      });

      // Document attachment
      let pendingDocument = null;

      documentBtn.addEventListener("click", async () => {
        try {
          const result = await ipcRenderer.invoke("select-document");
          if (result.success) {
            pendingDocument = result.document;
            renderAttachmentPreview(pendingDocument);
            input.focus();
          } else if (result.error) {
            addMessage(`Document selection failed: ${result.error}`, "error");
          }
        } catch (err) {
          addMessage(`Document error: ${err.message || "Unknown error"}`, "error");
        }
      });

      function renderAttachmentPreview(doc) {
        const area = document.getElementById("attachmentArea");
        area.style.display = "block";
        area.innerHTML = `
          <div class="document-preview">
            <div class="document-preview-icon">${getFileIcon(doc.type)}</div>
            <div class="document-preview-info">
              <div class="document-preview-name">${escapeHtml(doc.name)}</div>
              <div class="document-preview-meta">${formatFileSize(doc.size)} ‚Ä¢ ${doc.type}</div>
            </div>
            <button class="document-preview-remove" onclick="clearAttachment()">√ó</button>
          </div>
        `;
      }

      function clearAttachment() {
        pendingDocument = null;
        const area = document.getElementById("attachmentArea");
        area.style.display = "none";
        area.innerHTML = "";
        input.focus();
      }

      function getFileIcon(type) {
        const icons = { pdf: "üìÑ", image: "üñºÔ∏è", text: "üìù", default: "üìé" };
        return icons[type] || icons.default;
      }

      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + " B";
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
        return (bytes / (1024 * 1024)).toFixed(1) + " MB";
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Make clearAttachment available globally
      window.clearAttachment = clearAttachment;

      // Listen for tool events from main process
      ipcRenderer.on("tool-event", (event, data) => {
        if (emptyState && emptyState.parentNode) {
          emptyState.remove();
        }

        const toolEl = document.createElement("div");
        toolEl.className = `tool-activity ${data.type === "complete" ? "complete" : ""}`;

        if (data.type === "start") {
          toolEl.innerHTML = `<span class="tool-icon">‚öôÔ∏è</span> Running: ${data.toolName}`;
        } else {
          toolEl.innerHTML = `<span class="tool-icon">‚úì</span> Completed: ${data.toolName}`;
        }

        chatContainer.appendChild(toolEl);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      });

      // Listen for AI-triggered screenshot captures
      ipcRenderer.on("screenshot-captured", (_event, data) => {
        const imageRef = data.url || data.path;
        if (imageRef) {
          addMessage(`[screenshot:${imageRef}]Screenshot captured`, "assistant");
        }
      });

      // Listen for actual model usage from SDK ‚Äî verify badge matches configured model
      let configuredModel = "";
      ipcRenderer.invoke("get-config").then((cfg) => { configuredModel = cfg.model || ""; });

      ipcRenderer.on("model-usage", (_event, data) => {
        if (!data.model) return;
        const actual = data.model;
        modelBadge.textContent = actual;
        modelBadge.title = `Actual: ${actual}` + (configuredModel && actual !== configuredModel ? ` (configured: ${configuredModel})` : "");

        if (configuredModel && actual !== configuredModel) {
          modelBadge.className = "pill mismatch";
        } else {
          modelBadge.className = "pill verified";
        }
      });

      // ============ WIDGET SYSTEM ============

      // Helper to format seconds as MM:SS
      function formatTime(seconds) {
        const m = Math.floor(Math.abs(seconds) / 60);
        const s = Math.abs(seconds) % 60;
        return `${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
      }

      // Beep sound as base64 (short beep)
      const BEEP_SOUND = "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2LkZaYlpGLfXJkVUlBQEZRYHB+ipSam5mVjYN3a11NQz0+SVlqfIuWnZ6clo2CdWZYSkA7P0xfcYKQm6GhnpiOgnZnVklAO0FNYHF/jZieoZ2Xj4RzZ1dMQT1AU2N0hJGboKGdl4yAc2RYSUM/Q1NmdYWTnaKinJaLgHNmWEtCPkJPYHB/jZafn5yYkYZ6b2JVSkRFT1pqdoWSm52cmJOJfXJmW1FLSlBaZ3WCj5mcnZuYkoiAdGxiWlVUWGFteoaSmZubnJmUjoR7c2xnY2JkanuGkJebnZ6dnJiSi4N8dnJvbXB0e4KJj5OWmJmZmJaVkY2Kh4WEhYaIio2Qk5WWl5eXl5aWlZOSkI6NjIuLi4yNjpCRkpOUlJSVlJSTkpGQj4+Ojo6Oj4+QkJGRkpKSkpKSkZGQkI+Pjo6Ojo6OjY2NjY2NjY2NjY2NjY6Ojo6Ojo6Ojo6Ojo6Ojo6Ojo6Ojo6Ojo+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj5CQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkA==";

      function playBeep() {
        try {
          const audio = new Audio(BEEP_SOUND);
          audio.volume = 0.5;
          audio.play();
        } catch (e) {
          console.log("Could not play beep");
        }
      }

      // Timer Widget (counts up)
      function createTimerWidget() {
        let seconds = 0;
        let intervalId = null;
        let running = false;

        const widget = document.createElement("div");
        widget.className = "widget";
        widget.innerHTML = `
          <div class="widget-header">‚è±Ô∏è Timer</div>
          <div class="widget-display">00:00</div>
          <div class="widget-controls">
            <button class="widget-btn primary start-btn">Start</button>
            <button class="widget-btn reset-btn">Reset</button>
          </div>
        `;

        const display = widget.querySelector(".widget-display");
        const startBtn = widget.querySelector(".start-btn");
        const resetBtn = widget.querySelector(".reset-btn");

        startBtn.onclick = () => {
          if (running) {
            clearInterval(intervalId);
            startBtn.textContent = "Start";
            startBtn.classList.add("primary");
            running = false;
          } else {
            intervalId = setInterval(() => {
              seconds++;
              display.textContent = formatTime(seconds);
            }, 1000);
            startBtn.textContent = "Pause";
            startBtn.classList.remove("primary");
            running = true;
          }
        };

        resetBtn.onclick = () => {
          clearInterval(intervalId);
          seconds = 0;
          display.textContent = formatTime(seconds);
          startBtn.textContent = "Start";
          startBtn.classList.add("primary");
          running = false;
        };

        return widget;
      }

      // Countdown Widget
      function createCountdownWidget(duration, label) {
        let remaining = duration;
        let intervalId = null;
        let running = false;
        const originalDuration = duration;

        const widget = document.createElement("div");
        widget.className = "widget";
        widget.innerHTML = `
          <div class="widget-header">‚è≥ ${label || "Countdown"}</div>
          <div class="widget-display">${formatTime(remaining)}</div>
          <div class="widget-controls">
            <button class="widget-btn primary start-btn">Start</button>
            <button class="widget-btn reset-btn">Reset</button>
          </div>
        `;

        const display = widget.querySelector(".widget-display");
        const startBtn = widget.querySelector(".start-btn");
        const resetBtn = widget.querySelector(".reset-btn");

        startBtn.onclick = () => {
          if (running) {
            clearInterval(intervalId);
            startBtn.textContent = "Start";
            startBtn.classList.add("primary");
            running = false;
          } else if (remaining > 0) {
            intervalId = setInterval(() => {
              remaining--;
              display.textContent = formatTime(remaining);
              if (remaining <= 0) {
                clearInterval(intervalId);
                display.classList.add("done");
                display.textContent = "Done!";
                startBtn.textContent = "Done";
                startBtn.disabled = true;
                playBeep();
                running = false;
              }
            }, 1000);
            startBtn.textContent = "Pause";
            startBtn.classList.remove("primary");
            running = true;
          }
        };

        resetBtn.onclick = () => {
          clearInterval(intervalId);
          remaining = originalDuration;
          display.textContent = formatTime(remaining);
          display.classList.remove("done");
          startBtn.textContent = "Start";
          startBtn.classList.add("primary");
          startBtn.disabled = false;
          running = false;
        };

        return widget;
      }

      // Pomodoro Widget
      function createPomodoroWidget() {
        const WORK_TIME = 25 * 60; // 25 minutes
        const BREAK_TIME = 5 * 60; // 5 minutes
        let remaining = WORK_TIME;
        let isWork = true;
        let intervalId = null;
        let running = false;
        let cycles = 0;

        const widget = document.createElement("div");
        widget.className = "widget";
        widget.innerHTML = `
          <div class="widget-header">üçÖ Pomodoro</div>
          <div class="widget-display">${formatTime(remaining)}</div>
          <div class="widget-status">Work Session</div>
          <div class="widget-controls">
            <button class="widget-btn primary start-btn">Start</button>
            <button class="widget-btn skip-btn">Skip</button>
            <button class="widget-btn reset-btn">Reset</button>
          </div>
        `;

        const display = widget.querySelector(".widget-display");
        const status = widget.querySelector(".widget-status");
        const startBtn = widget.querySelector(".start-btn");
        const skipBtn = widget.querySelector(".skip-btn");
        const resetBtn = widget.querySelector(".reset-btn");

        function switchMode() {
          isWork = !isWork;
          remaining = isWork ? WORK_TIME : BREAK_TIME;
          if (!isWork) cycles++;
          status.textContent = isWork ? "Work Session" : `Break Time (${cycles} completed)`;
          display.textContent = formatTime(remaining);
          display.classList.remove("done");
          playBeep();
        }

        startBtn.onclick = () => {
          if (running) {
            clearInterval(intervalId);
            startBtn.textContent = "Start";
            startBtn.classList.add("primary");
            running = false;
          } else {
            intervalId = setInterval(() => {
              remaining--;
              display.textContent = formatTime(remaining);
              if (remaining <= 0) {
                clearInterval(intervalId);
                running = false;
                switchMode();
                startBtn.textContent = "Start";
                startBtn.classList.add("primary");
              }
            }, 1000);
            startBtn.textContent = "Pause";
            startBtn.classList.remove("primary");
            running = true;
          }
        };

        skipBtn.onclick = () => {
          clearInterval(intervalId);
          running = false;
          switchMode();
          startBtn.textContent = "Start";
          startBtn.classList.add("primary");
        };

        resetBtn.onclick = () => {
          clearInterval(intervalId);
          isWork = true;
          remaining = WORK_TIME;
          cycles = 0;
          status.textContent = "Work Session";
          display.textContent = formatTime(remaining);
          display.classList.remove("done");
          startBtn.textContent = "Start";
          startBtn.classList.add("primary");
          running = false;
        };

        return widget;
      }

      // Listen for widget events from main process
      // Unit Converter Widget
      const unitData = {
        length: {
          units: ["meters", "kilometers", "centimeters", "millimeters", "miles", "yards", "feet", "inches"],
          base: "meters",
          factors: { meters: 1, kilometers: 0.001, centimeters: 100, millimeters: 1000, miles: 0.000621371, yards: 1.09361, feet: 3.28084, inches: 39.3701 }
        },
        weight: {
          units: ["kilograms", "grams", "milligrams", "pounds", "ounces", "stones"],
          base: "kilograms",
          factors: { kilograms: 1, grams: 1000, milligrams: 1000000, pounds: 2.20462, ounces: 35.274, stones: 0.157473 }
        },
        temperature: {
          units: ["celsius", "fahrenheit", "kelvin"],
          base: "celsius",
          factors: null // special handling
        },
        volume: {
          units: ["liters", "milliliters", "gallons", "quarts", "pints", "cups", "fluid_ounces"],
          base: "liters",
          factors: { liters: 1, milliliters: 1000, gallons: 0.264172, quarts: 1.05669, pints: 2.11338, cups: 4.22675, fluid_ounces: 33.814 }
        },
        area: {
          units: ["square_meters", "square_kilometers", "square_feet", "square_yards", "acres", "hectares"],
          base: "square_meters",
          factors: { square_meters: 1, square_kilometers: 0.000001, square_feet: 10.7639, square_yards: 1.19599, acres: 0.000247105, hectares: 0.0001 }
        },
        speed: {
          units: ["meters_per_second", "kilometers_per_hour", "miles_per_hour", "knots"],
          base: "meters_per_second",
          factors: { meters_per_second: 1, kilometers_per_hour: 3.6, miles_per_hour: 2.23694, knots: 1.94384 }
        }
      };

      function convertValue(value, fromUnit, toUnit, category) {
        if (category === "temperature") {
          let celsius;
          if (fromUnit === "celsius") celsius = value;
          else if (fromUnit === "fahrenheit") celsius = (value - 32) * 5 / 9;
          else if (fromUnit === "kelvin") celsius = value - 273.15;
          else return null;

          if (toUnit === "celsius") return celsius;
          if (toUnit === "fahrenheit") return celsius * 9 / 5 + 32;
          if (toUnit === "kelvin") return celsius + 273.15;
          return null;
        }

        const data = unitData[category];
        if (!data || !data.factors) return null;
        const baseValue = value / data.factors[fromUnit];
        return baseValue * data.factors[toUnit];
      }

      function createUnitConverterWidget(initialCategory) {
        let category = initialCategory || "length";

        const widget = document.createElement("div");
        widget.className = "widget";
        widget.style.maxWidth = "340px";

        function render() {
          const data = unitData[category];
          const units = data.units;

          widget.innerHTML = `
            <div class="widget-header">üìê Unit Converter</div>
            <div class="converter-tabs">
              ${Object.keys(unitData).map(cat =>
                `<button class="converter-tab ${cat === category ? 'active' : ''}" data-cat="${cat}">${cat}</button>`
              ).join('')}
            </div>
            <div class="converter-row">
              <input type="number" class="converter-input" id="fromValue" value="1" />
              <select class="converter-select" id="fromUnit">
                ${units.map((u, i) => `<option value="${u}" ${i === 0 ? 'selected' : ''}>${u.replace(/_/g, ' ')}</option>`).join('')}
              </select>
            </div>
            <div class="converter-arrow" style="text-align: center;">‚Üì</div>
            <div class="converter-row">
              <input type="text" class="converter-input" id="toValue" readonly />
              <select class="converter-select" id="toUnit">
                ${units.map((u, i) => `<option value="${u}" ${i === 1 ? 'selected' : ''}>${u.replace(/_/g, ' ')}</option>`).join('')}
              </select>
            </div>
          `;

          const fromValue = widget.querySelector("#fromValue");
          const fromUnit = widget.querySelector("#fromUnit");
          const toValue = widget.querySelector("#toValue");
          const toUnit = widget.querySelector("#toUnit");
          const tabs = widget.querySelectorAll(".converter-tab");

          function update() {
            const val = parseFloat(fromValue.value) || 0;
            const result = convertValue(val, fromUnit.value, toUnit.value, category);
            toValue.value = result !== null ? (Math.round(result * 1000000) / 1000000).toString() : "Error";
          }

          fromValue.addEventListener("input", update);
          fromUnit.addEventListener("change", update);
          toUnit.addEventListener("change", update);

          tabs.forEach(tab => {
            tab.addEventListener("click", () => {
              category = tab.dataset.cat;
              render();
            });
          });

          update();
        }

        render();
        return widget;
      }

      // World Clock Widget
      function createWorldClockWidget(cities) {
        const widget = document.createElement("div");
        widget.className = "widget";
        widget.style.maxWidth = "320px";

        const header = document.createElement("div");
        header.className = "widget-header";
        header.textContent = "üåç World Clock";
        widget.appendChild(header);

        const list = document.createElement("div");
        list.className = "worldclock-list";

        function formatCityTime(timezone) {
          const now = new Date();
          const timeFormatter = new Intl.DateTimeFormat("en-US", {
            timeZone: timezone,
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: true,
          });
          const dateFormatter = new Intl.DateTimeFormat("en-US", {
            timeZone: timezone,
            weekday: "short",
            month: "short",
            day: "numeric",
          });
          return {
            time: timeFormatter.format(now),
            date: dateFormatter.format(now),
          };
        }

        function updateTimes() {
          list.innerHTML = "";
          cities.forEach((city) => {
            const { time, date } = formatCityTime(city.timezone);
            const cityEl = document.createElement("div");
            cityEl.className = "worldclock-city";
            cityEl.innerHTML = `
              <div>
                <div class="worldclock-city-name">${city.name}</div>
                <div class="worldclock-city-date">${date}</div>
              </div>
              <div class="worldclock-city-time">${time}</div>
            `;
            list.appendChild(cityEl);
          });
        }

        updateTimes();
        widget.appendChild(list);

        // Update every second
        const intervalId = setInterval(updateTimes, 1000);

        // Clean up when widget is removed
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            mutation.removedNodes.forEach((node) => {
              if (node === widget || node.contains(widget)) {
                clearInterval(intervalId);
                observer.disconnect();
              }
            });
          });
        });
        observer.observe(chatContainer, { childList: true, subtree: true });

        return widget;
      }

      // Build a safe <table> from chart labels + datasets (no innerHTML with user data)
      function buildChartTable(labels, datasets) {
        const table = document.createElement("table");
        table.className = "chart-table";

        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        const labelTh = document.createElement("th");
        labelTh.textContent = "Label";
        headerRow.appendChild(labelTh);
        for (const ds of datasets) {
          const th = document.createElement("th");
          th.textContent = ds.label;
          headerRow.appendChild(th);
        }
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        for (let i = 0; i < labels.length; i++) {
          const row = document.createElement("tr");
          const labelTd = document.createElement("td");
          labelTd.textContent = labels[i];
          row.appendChild(labelTd);
          for (const ds of datasets) {
            const td = document.createElement("td");
            td.textContent = String(ds.data[i] ?? "");
            row.appendChild(td);
          }
          tbody.appendChild(row);
        }
        table.appendChild(tbody);
        return table;
      }

      // Chart Widget
      async function createChartWidget(data) {
        const widget = document.createElement("div");
        widget.className = "chart-widget";

        // Title
        if (data.chartTitle) {
          const title = document.createElement("div");
          title.className = "chart-widget-title";
          title.textContent = data.chartTitle;
          widget.appendChild(title);
        }

        const labels = data.chartLabels || [];
        const datasets = data.chartDatasets || [];

        // Handle table type separately (no Chart.js needed)
        if (data.chartType === "table") {
          widget.appendChild(buildChartTable(labels, datasets));
          return widget;
        }

        // Try to use Chart.js for charts
        const chartLib = await initChartJs();

        if (!chartLib) {
          // Fallback to table if Chart.js unavailable
          const fallback = document.createElement("div");
          fallback.className = "chart-widget-fallback";
          fallback.textContent = "Chart rendering unavailable. Showing data as table:";
          fallback.appendChild(buildChartTable(labels, datasets));
          widget.appendChild(fallback);
          return widget;
        }

        // Create canvas container
        const canvasContainer = document.createElement("div");
        canvasContainer.className = "chart-widget-canvas-container";

        const canvas = document.createElement("canvas");
        canvas.id = `chart-${Date.now()}`;
        canvasContainer.appendChild(canvas);
        widget.appendChild(canvasContainer);

        // Detect theme for chart colors
        const isDark = !document.documentElement.hasAttribute("data-theme") ||
                       document.documentElement.getAttribute("data-theme") !== "light";

        const textColor = isDark ? "#e0e0e0" : "#1a1a1a";
        const gridColor = isDark ? "rgba(255, 255, 255, 0.1)" : "rgba(0, 0, 0, 0.1)";

        // Build chart configuration
        let chartConfig;

        if (data.chartType === "scatter") {
          chartConfig = {
            type: "scatter",
            data: {
              datasets: [{
                label: data.chartTitle || "Scatter",
                data: data.scatterData || [],
                backgroundColor: "rgba(0, 102, 255, 0.6)",
              }],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
              },
              scales: {
                x: {
                  title: { display: !!data.xLabel, text: data.xLabel || "", color: textColor },
                  ticks: { color: textColor },
                  grid: { color: gridColor },
                },
                y: {
                  title: { display: !!data.yLabel, text: data.yLabel || "", color: textColor },
                  ticks: { color: textColor },
                  grid: { color: gridColor },
                },
              },
            },
          };
        } else {
          // Determine chart type for Chart.js
          let jsChartType = data.chartType;
          if (data.chartType === "horizontalBar") {
            jsChartType = "bar";
          }

          chartConfig = {
            type: jsChartType,
            data: {
              labels: data.chartLabels || [],
              datasets: (data.chartDatasets || []).map((ds, idx) => ({
                label: ds.label,
                data: ds.data,
                backgroundColor: ds.backgroundColor,
                borderColor: isDark ? "rgba(255, 255, 255, 0.2)" : "rgba(0, 0, 0, 0.2)",
                borderWidth: 1,
              })),
            },
            options: {
              indexAxis: data.chartType === "horizontalBar" ? "y" : "x",
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: (data.chartDatasets || []).length > 1,
                  labels: { color: textColor },
                },
              },
              scales: data.chartType === "pie" || data.chartType === "doughnut" ? {} : {
                x: {
                  ticks: { color: textColor },
                  grid: { color: gridColor },
                  title: { display: !!data.xLabel, text: data.xLabel || "", color: textColor },
                },
                y: {
                  ticks: { color: textColor },
                  grid: { color: gridColor },
                  title: { display: !!data.yLabel, text: data.yLabel || "", color: textColor },
                },
              },
            },
          };
        }

        // Create chart
        try {
          new chartLib(canvas.getContext("2d"), chartConfig);
        } catch (e) {
          console.error("[Chart] Failed to create chart:", e);
          const errDiv = document.createElement("div");
          errDiv.className = "chart-widget-fallback";
          errDiv.textContent = `Failed to render chart: ${e.message}`;
          widget.replaceChildren(errDiv);
        }

        return widget;
      }

      // WiFi Widget
      function createWifiWidget(data) {
        const widget = document.createElement("div");
        widget.className = "widget";
        widget.style.maxWidth = "300px";

        const header = document.createElement("div");
        header.className = "widget-header";
        header.textContent = "üì∂ WiFi Networks";
        widget.appendChild(header);

        // Status section
        const status = document.createElement("div");
        status.className = "wifi-status";
        
        let statusIcon, statusBadge, networkName;
        
        if (!data.enabled) {
          statusIcon = "üìµ";
          statusBadge = '<span class="wifi-status-badge off">OFF</span>';
          networkName = "WiFi Disabled";
        } else if (data.connected && data.currentNetwork) {
          statusIcon = "‚úÖ";
          statusBadge = '<span class="wifi-status-badge connected">Connected</span>';
          networkName = data.currentNetwork;
        } else {
          statusIcon = "‚ö†Ô∏è";
          statusBadge = '<span class="wifi-status-badge disconnected">Not Connected</span>';
          networkName = "No Network";
        }
        
        status.innerHTML = `
          <span class="wifi-status-icon">${statusIcon}</span>
          <div class="wifi-status-info">
            <div class="wifi-status-label">Current Network</div>
            <div class="wifi-status-network">${networkName}</div>
          </div>
          ${statusBadge}
        `;
        widget.appendChild(status);

        // Saved networks list
        if (data.savedNetworks && data.savedNetworks.length > 0) {
          const listHeader = document.createElement("div");
          listHeader.className = "widget-header";
          listHeader.style.marginTop = "8px";
          listHeader.textContent = `Saved Networks (${data.savedNetworks.length})`;
          widget.appendChild(listHeader);

          const list = document.createElement("div");
          list.className = "wifi-networks-list";
          
          data.savedNetworks.forEach((network) => {
            const isCurrent = network === data.currentNetwork;
            const item = document.createElement("div");
            item.className = `wifi-network-item ${isCurrent ? "current" : ""}`;
            item.innerHTML = `
              <span class="wifi-network-icon">${isCurrent ? "üì∂" : "üì°"}</span>
              <span>${network}</span>
              ${isCurrent ? '<span class="wifi-status-badge connected">Connected</span>' : ""}
            `;
            list.appendChild(item);
          });
          
          widget.appendChild(list);
        }

        // Error message if any
        if (data.error) {
          const errorEl = document.createElement("div");
          errorEl.style.cssText = "color: var(--error-text); font-size: 11px; margin-top: 8px;";
          errorEl.textContent = data.error;
          widget.appendChild(errorEl);
        }

        return widget;
      }

      ipcRenderer.on("render-widget", (event, data) => {
        if (emptyState && emptyState.parentNode) {
          emptyState.remove();
        }

        // Widget is the response - clear loading state
        hideTypingIndicator();
        isLoading = false;
        sendBtn.textContent = "Send";
        updateSendBtn();

        let widget;
        switch (data.type) {
          case "timer":
            widget = createTimerWidget();
            break;
          case "countdown":
            widget = createCountdownWidget(data.duration || 60, data.label);
            break;
          case "pomodoro":
            widget = createPomodoroWidget();
            break;
          case "worldclock":
            widget = createWorldClockWidget(data.cities || []);
            break;
          case "unitconverter":
            widget = createUnitConverterWidget(data.category);
            break;
          case "wifi":
            widget = createWifiWidget(data);
            break;
          case "chart":
            createChartWidget(data).then(w => {
              if (w) {
                chatContainer.appendChild(w);
                chatContainer.scrollTop = chatContainer.scrollHeight;
              }
            });
            return; // Return early since we handle append in the promise
        }

        if (widget) {
          chatContainer.appendChild(widget);
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
      });
    </script>
  </body>
</html>
