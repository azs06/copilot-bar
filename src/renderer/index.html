<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Copilot Bar</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #1a1a1a;
        color: #e0e0e0;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid #333;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .header h1 {
        font-size: 14px;
        font-weight: 600;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .header h1 svg {
        width: 18px;
        height: 18px;
        fill: #fff;
      }

      .model-badge {
        font-size: 10px;
        padding: 3px 8px;
        background: #333;
        color: #888;
        border-radius: 10px;
        font-weight: 500;
      }

      .header-actions {
        display: flex;
        gap: 4px;
      }

      .config-btn {
        background: none;
        border: none;
        color: #888;
        cursor: pointer;
        font-size: 14px;
        padding: 4px 8px;
        border-radius: 4px;
      }

      .config-btn:hover {
        color: #fff;
        background: #333;
      }

      .chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .message {
        padding: 10px 14px;
        border-radius: 12px;
        max-width: 85%;
        font-size: 13px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .message.user {
        background: #0066ff;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
      }

      .message.assistant {
        background: #2a2a2a;
        color: #e0e0e0;
        align-self: flex-start;
        border-bottom-left-radius: 4px;
      }

      .message.error {
        background: #4a1c1c;
        color: #ff6b6b;
      }

      .empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #666;
        text-align: center;
        padding: 20px;
      }

      .empty-state svg {
        width: 48px;
        height: 48px;
        fill: #444;
        margin-bottom: 12px;
      }

      .empty-state p {
        font-size: 13px;
      }

      .input-area {
        padding: 12px 16px;
        border-top: 1px solid #333;
        display: flex;
        gap: 8px;
      }

      textarea {
        flex: 1;
        padding: 10px 12px;
        border: 1px solid #333;
        border-radius: 8px;
        background: #252525;
        color: #e0e0e0;
        font-size: 13px;
        resize: none;
        font-family: inherit;
        min-height: 40px;
        max-height: 120px;
      }

      textarea:focus {
        outline: none;
        border-color: #0066ff;
      }

      .send-btn {
        padding: 10px 16px;
        background: #0066ff;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .send-btn:hover {
        background: #0052cc;
      }

      .send-btn:disabled {
        background: #333;
        color: #666;
        cursor: not-allowed;
      }

      .loading {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid #fff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 12px 14px;
      }

      .typing-indicator span {
        width: 6px;
        height: 6px;
        background: #666;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
      }

      .typing-indicator span:nth-child(1) {
        animation-delay: -0.32s;
      }

      .typing-indicator span:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      .tool-activity {
        font-size: 11px;
        color: #f0a020;
        padding: 6px 14px;
        background: #2a2a1a;
        border-radius: 8px;
        margin: 4px 0;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .tool-activity .tool-icon {
        font-size: 12px;
      }

      .tool-activity.complete {
        color: #40a040;
        background: #1a2a1a;
      }

      /* Widget Styles */
      .widget {
        background: #252525;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 16px;
        margin: 8px 0;
        max-width: 280px;
      }

      .widget-header {
        font-size: 11px;
        color: #888;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .widget-display {
        font-size: 42px;
        font-family: "SF Mono", "Monaco", "Menlo", monospace;
        color: #fff;
        text-align: center;
        margin: 16px 0;
        font-weight: 300;
      }

      .widget-display.done {
        color: #40c040;
      }

      .widget-status {
        font-size: 11px;
        color: #888;
        text-align: center;
        margin-bottom: 12px;
      }

      .widget-controls {
        display: flex;
        gap: 8px;
        justify-content: center;
      }

      .widget-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        background: #333;
        color: #fff;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.15s;
      }

      .widget-btn:hover {
        background: #444;
      }

      .widget-btn.primary {
        background: #0066ff;
      }

      .widget-btn.primary:hover {
        background: #0052cc;
      }

      .widget-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Settings Panel */
      .settings-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }

      .settings-panel {
        background: #252525;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 20px;
        width: 340px;
        max-width: 90%;
      }

      .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .settings-header h2 {
        font-size: 16px;
        font-weight: 600;
        color: #fff;
      }

      .settings-close {
        background: none;
        border: none;
        color: #888;
        font-size: 20px;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
      }

      .settings-close:hover {
        color: #fff;
        background: #333;
      }

      .settings-row {
        margin-bottom: 16px;
      }

      .settings-row label {
        display: block;
        font-size: 12px;
        color: #888;
        margin-bottom: 6px;
      }

      .settings-row input,
      .settings-row select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #333;
        border-radius: 6px;
        background: #1a1a1a;
        color: #e0e0e0;
        font-size: 13px;
        font-family: inherit;
      }

      .settings-row input:focus,
      .settings-row select:focus {
        outline: none;
        border-color: #0066ff;
      }

      .settings-hint {
        font-size: 11px;
        color: #666;
        margin-top: 4px;
      }

      .settings-row .shortcut-display {
        font-family: "SF Mono", monospace;
        background: #1a1a1a;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        color: #0066ff;
        display: inline-block;
      }

      .settings-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      .settings-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
      }

      .settings-btn.secondary {
        background: #333;
        color: #fff;
      }

      .settings-btn.secondary:hover {
        background: #444;
      }

      .settings-btn.primary {
        background: #0066ff;
        color: #fff;
      }

      .settings-btn.primary:hover {
        background: #0052cc;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-left">
        <h1>
          <svg viewBox="0 0 512 416" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M181.33 266.143c0-11.497 9.32-20.818 20.818-20.818 11.498 0 20.819 9.321 20.819 20.818v38.373c0 11.497-9.321 20.818-20.819 20.818-11.497 0-20.818-9.32-20.818-20.818v-38.373zM308.807 245.325c-11.477 0-20.798 9.321-20.798 20.818v38.373c0 11.497 9.32 20.818 20.798 20.818 11.497 0 20.818-9.32 20.818-20.818v-38.373c0-11.497-9.32-20.818-20.818-20.818z"
            />
            <path
              d="M512.002 246.393v57.384c-.02 7.411-3.696 14.638-9.67 19.011C431.767 374.444 344.695 416 256 416c-98.138 0-196.379-56.542-246.33-93.21-5.975-4.374-9.65-11.6-9.671-19.012v-57.384a35.347 35.347 0 016.857-20.922l15.583-21.085c8.336-11.312 20.757-14.31 33.98-14.31 4.988-56.953 16.794-97.604 45.024-127.354C155.194 5.77 226.56 0 256 0c29.441 0 100.807 5.77 154.557 62.722 28.19 29.75 40.036 70.401 45.025 127.354 13.263 0 25.602 2.936 33.958 14.31l15.583 21.127c4.476 6.077 6.878 13.345 6.878 20.88zm-97.666-26.075c-.677-13.058-11.292-18.19-22.338-21.824-11.64 7.309-25.848 10.183-39.46 10.183-14.454 0-41.432-3.47-63.872-25.869-5.667-5.625-9.527-14.454-12.155-24.247a212.902 212.902 0 00-20.469-1.088c-6.098 0-13.099.349-20.551 1.088-2.628 9.793-6.509 18.622-12.155 24.247-22.4 22.4-49.418 25.87-63.872 25.87-13.612 0-27.86-2.855-39.501-10.184-11.005 3.613-21.558 8.828-22.277 21.824-1.17 24.555-1.272 49.11-1.375 73.645-.041 12.318-.082 24.658-.288 36.976.062 7.166 4.374 13.818 10.882 16.774 52.97 24.124 103.045 36.278 149.137 36.278 46.01 0 96.085-12.154 149.014-36.278 6.508-2.956 10.84-9.608 10.881-16.774.637-36.832.124-73.809-1.642-110.62h.041z"
            />
          </svg>
          Copilot Bar
        </h1>
        <span class="model-badge" id="modelBadge">loading...</span>
      </div>
      <div class="header-actions">
        <button class="config-btn" id="clearBtn" title="Clear chat">üóëÔ∏è</button>
        <button class="config-btn" id="configBtn" title="Settings">‚öôÔ∏è</button>
      </div>
    </div>

    <div class="chat-container" id="chatContainer">
      <div class="empty-state" id="emptyState">
        <svg viewBox="0 0 512 416" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M181.33 266.143c0-11.497 9.32-20.818 20.818-20.818 11.498 0 20.819 9.321 20.819 20.818v38.373c0 11.497-9.321 20.818-20.819 20.818-11.497 0-20.818-9.32-20.818-20.818v-38.373zM308.807 245.325c-11.477 0-20.798 9.321-20.798 20.818v38.373c0 11.497 9.32 20.818 20.798 20.818 11.497 0 20.818-9.32 20.818-20.818v-38.373c0-11.497-9.32-20.818-20.818-20.818z"
          />
          <path
            d="M512.002 246.393v57.384c-.02 7.411-3.696 14.638-9.67 19.011C431.767 374.444 344.695 416 256 416c-98.138 0-196.379-56.542-246.33-93.21-5.975-4.374-9.65-11.6-9.671-19.012v-57.384a35.347 35.347 0 016.857-20.922l15.583-21.085c8.336-11.312 20.757-14.31 33.98-14.31 4.988-56.953 16.794-97.604 45.024-127.354C155.194 5.77 226.56 0 256 0c29.441 0 100.807 5.77 154.557 62.722 28.19 29.75 40.036 70.401 45.025 127.354 13.263 0 25.602 2.936 33.958 14.31l15.583 21.127c4.476 6.077 6.878 13.345 6.878 20.88zm-97.666-26.075c-.677-13.058-11.292-18.19-22.338-21.824-11.64 7.309-25.848 10.183-39.46 10.183-14.454 0-41.432-3.47-63.872-25.869-5.667-5.625-9.527-14.454-12.155-24.247a212.902 212.902 0 00-20.469-1.088c-6.098 0-13.099.349-20.551 1.088-2.628 9.793-6.509 18.622-12.155 24.247-22.4 22.4-49.418 25.87-63.872 25.87-13.612 0-27.86-2.855-39.501-10.184-11.005 3.613-21.558 8.828-22.277 21.824-1.17 24.555-1.272 49.11-1.375 73.645-.041 12.318-.082 24.658-.288 36.976.062 7.166 4.374 13.818 10.882 16.774 52.97 24.124 103.045 36.278 149.137 36.278 46.01 0 96.085-12.154 149.014-36.278 6.508-2.956 10.84-9.608 10.881-16.774.637-36.832.124-73.809-1.642-110.62h.041z"
          />
        </svg>
        <p>Ask me anything</p>
      </div>
    </div>

    <div class="input-area">
      <textarea
        id="input"
        placeholder="Ask Copilot..."
        rows="1"
        autofocus
      ></textarea>
      <button class="send-btn" id="sendBtn">Send</button>
    </div>

    <script>
      const { ipcRenderer } = require("electron");

      const input = document.getElementById("input");
      const sendBtn = document.getElementById("sendBtn");
      const chatContainer = document.getElementById("chatContainer");
      let emptyState = document.getElementById("emptyState");
      const configBtn = document.getElementById("configBtn");
      const clearBtn = document.getElementById("clearBtn");
      const modelBadge = document.getElementById("modelBadge");

      let isLoading = false;

      // Load and display current model
      async function loadConfig() {
        try {
          const config = await ipcRenderer.invoke("get-config");
          modelBadge.textContent = config.model || "unknown";
        } catch (err) {
          modelBadge.textContent = "error";
        }
      }
      loadConfig();

      function addMessage(content, type) {
        if (emptyState) {
          emptyState.remove();
        }

        const msg = document.createElement("div");
        msg.className = `message ${type}`;
        msg.textContent = content;
        chatContainer.appendChild(msg);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return msg;
      }

      function showTypingIndicator() {
        const indicator = document.createElement("div");
        indicator.className = "message assistant typing-indicator";
        indicator.id = "typingIndicator";
        indicator.innerHTML = "<span></span><span></span><span></span>";
        chatContainer.appendChild(indicator);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function hideTypingIndicator() {
        const indicator = document.getElementById("typingIndicator");
        if (indicator) indicator.remove();
      }

      async function sendMessage() {
        const prompt = input.value.trim();
        if (!prompt || isLoading) return;

        isLoading = true;
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<span class="loading"></span>';

        addMessage(prompt, "user");
        input.value = "";
        input.style.height = "auto";

        showTypingIndicator();

        try {
          const result = await ipcRenderer.invoke("chat", prompt);
          hideTypingIndicator();

          if (result.success) {
            addMessage(result.result, "assistant");
          } else {
            addMessage("Error: " + result.error, "error");
          }
        } catch (err) {
          hideTypingIndicator();
          addMessage("Error: " + err.message, "error");
        } finally {
          isLoading = false;
          sendBtn.disabled = false;
          sendBtn.textContent = "Send";
          input.focus();
        }
      }

      sendBtn.addEventListener("click", sendMessage);

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Auto-resize textarea
      input.addEventListener("input", () => {
        input.style.height = "auto";
        input.style.height = Math.min(input.scrollHeight, 120) + "px";
      });

      // Settings panel
      let currentConfig = {};

      function showSettings() {
        const overlay = document.createElement("div");
        overlay.className = "settings-overlay";
        overlay.innerHTML = `
          <div class="settings-panel">
            <div class="settings-header">
              <h2>Settings</h2>
              <button class="settings-close">&times;</button>
            </div>
            <div class="settings-row">
              <label>Model</label>
              <select id="settingsModel">
                <option value="gpt-5-mini">gpt-5-mini</option>
                <option value="gpt-5">gpt-5</option>
                <option value="claude-3.5-sonnet">claude-3.5-sonnet</option>
                <option value="claude-4-opus">claude-4-opus</option>
              </select>
            </div>
            <div class="settings-row">
              <label>Global Shortcut</label>
              <div class="shortcut-display" id="shortcutDisplay">${currentConfig.shortcut || "..."}</div>
              <p class="settings-hint">Press any key combination to change</p>
              <input type="text" id="shortcutInput" placeholder="Press keys..." readonly style="margin-top: 8px;" />
            </div>
            <div class="settings-actions">
              <button class="settings-btn secondary" id="settingsCancel">Cancel</button>
              <button class="settings-btn primary" id="settingsSave">Save</button>
            </div>
          </div>
        `;

        document.body.appendChild(overlay);

        const modelSelect = overlay.querySelector("#settingsModel");
        const shortcutInput = overlay.querySelector("#shortcutInput");
        const shortcutDisplay = overlay.querySelector("#shortcutDisplay");
        const closeBtn = overlay.querySelector(".settings-close");
        const cancelBtn = overlay.querySelector("#settingsCancel");
        const saveBtn = overlay.querySelector("#settingsSave");

        // Set current values
        modelSelect.value = currentConfig.model || "gpt-5-mini";
        let newShortcut = currentConfig.shortcut;

        // Shortcut recording
        shortcutInput.addEventListener("keydown", (e) => {
          e.preventDefault();
          const parts = [];
          if (e.metaKey || e.ctrlKey) parts.push("CommandOrControl");
          if (e.altKey) parts.push("Alt");
          if (e.shiftKey) parts.push("Shift");

          const key = e.key;
          if (!["Control", "Shift", "Alt", "Meta"].includes(key)) {
            parts.push(key.length === 1 ? key.toUpperCase() : key);
          }

          if (parts.length > 1) {
            newShortcut = parts.join("+");
            shortcutInput.value = newShortcut;
            shortcutDisplay.textContent = newShortcut;
          }
        });

        // Close handlers
        const close = () => overlay.remove();
        closeBtn.onclick = close;
        cancelBtn.onclick = close;
        overlay.onclick = (e) => {
          if (e.target === overlay) close();
        };

        // Save handler
        saveBtn.onclick = async () => {
          const newModel = modelSelect.value;
          if (newModel !== currentConfig.model) {
            await ipcRenderer.invoke("set-config", "model", newModel);
            currentConfig.model = newModel;
            modelBadge.textContent = newModel;
          }
          if (newShortcut && newShortcut !== currentConfig.shortcut) {
            await ipcRenderer.invoke("set-config", "shortcut", newShortcut);
            currentConfig.shortcut = newShortcut;
          }
          close();
        };
      }

      configBtn.addEventListener("click", async () => {
        currentConfig = await ipcRenderer.invoke("get-config");
        showSettings();
      });

      // Clear chat
      clearBtn.addEventListener("click", () => {
        chatContainer.innerHTML = `
          <div class="empty-state" id="emptyState">
            <svg viewBox="0 0 512 416" xmlns="http://www.w3.org/2000/svg">
              <path d="M181.33 266.143c0-11.497 9.32-20.818 20.818-20.818 11.498 0 20.819 9.321 20.819 20.818v38.373c0 11.497-9.321 20.818-20.819 20.818-11.497 0-20.818-9.32-20.818-20.818v-38.373zM308.807 245.325c-11.477 0-20.798 9.321-20.798 20.818v38.373c0 11.497 9.32 20.818 20.798 20.818 11.497 0 20.818-9.32 20.818-20.818v-38.373c0-11.497-9.32-20.818-20.818-20.818z" />
              <path d="M512.002 246.393v57.384c-.02 7.411-3.696 14.638-9.67 19.011C431.767 374.444 344.695 416 256 416c-98.138 0-196.379-56.542-246.33-93.21-5.975-4.374-9.65-11.6-9.671-19.012v-57.384a35.347 35.347 0 016.857-20.922l15.583-21.085c8.336-11.312 20.757-14.31 33.98-14.31 4.988-56.953 16.794-97.604 45.024-127.354C155.194 5.77 226.56 0 256 0c29.441 0 100.807 5.77 154.557 62.722 28.19 29.75 40.036 70.401 45.025 127.354 13.263 0 25.602 2.936 33.958 14.31l15.583 21.127c4.476 6.077 6.878 13.345 6.878 20.88zm-97.666-26.075c-.677-13.058-11.292-18.19-22.338-21.824-11.64 7.309-25.848 10.183-39.46 10.183-14.454 0-41.432-3.47-63.872-25.869-5.667-5.625-9.527-14.454-12.155-24.247a212.902 212.902 0 00-20.469-1.088c-6.098 0-13.099.349-20.551 1.088-2.628 9.793-6.509 18.622-12.155 24.247-22.4 22.4-49.418 25.87-63.872 25.87-13.612 0-27.86-2.855-39.501-10.184-11.005 3.613-21.558 8.828-22.277 21.824-1.17 24.555-1.272 49.11-1.375 73.645-.041 12.318-.082 24.658-.288 36.976.062 7.166 4.374 13.818 10.882 16.774 52.97 24.124 103.045 36.278 149.137 36.278 46.01 0 96.085-12.154 149.014-36.278 6.508-2.956 10.84-9.608 10.881-16.774.637-36.832.124-73.809-1.642-110.62h.041z" />
            </svg>
            <p>Ask me anything</p>
          </div>
        `;
        emptyState = document.getElementById("emptyState");
        input.focus();
      });

      // Listen for tool events from main process
      ipcRenderer.on("tool-event", (event, data) => {
        if (emptyState && emptyState.parentNode) {
          emptyState.remove();
        }

        const toolEl = document.createElement("div");
        toolEl.className = `tool-activity ${data.type === "complete" ? "complete" : ""}`;

        if (data.type === "start") {
          toolEl.innerHTML = `<span class="tool-icon">‚öôÔ∏è</span> Running: ${data.toolName}`;
        } else {
          toolEl.innerHTML = `<span class="tool-icon">‚úì</span> Completed: ${data.toolName}`;
        }

        chatContainer.appendChild(toolEl);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      });

      // ============ WIDGET SYSTEM ============

      // Helper to format seconds as MM:SS
      function formatTime(seconds) {
        const m = Math.floor(Math.abs(seconds) / 60);
        const s = Math.abs(seconds) % 60;
        return `${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
      }

      // Beep sound as base64 (short beep)
      const BEEP_SOUND = "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2LkZaYlpGLfXJkVUlBQEZRYHB+ipSam5mVjYN3a11NQz0+SVlqfIuWnZ6clo2CdWZYSkA7P0xfcYKQm6GhnpiOgnZnVklAO0FNYHF/jZieoZ2Xj4RzZ1dMQT1AU2N0hJGboKGdl4yAc2RYSUM/Q1NmdYWTnaKinJaLgHNmWEtCPkJPYHB/jZafn5yYkYZ6b2JVSkRFT1pqdoWSm52cmJOJfXJmW1FLSlBaZ3WCj5mcnZuYkoiAdGxiWlVUWGFteoaSmZubnJmUjoR7c2xnY2JkanuGkJebnZ6dnJiSi4N8dnJvbXB0e4KJj5OWmJmZmJaVkY2Kh4WEhYaIio2Qk5WWl5eXl5aWlZOSkI6NjIuLi4yNjpCRkpOUlJSVlJSTkpGQj4+Ojo6Oj4+QkJGRkpKSkpKSkZGQkI+Pjo6Ojo6OjY2NjY2NjY2NjY2NjY6Ojo6Ojo6Ojo6Ojo6Ojo6Ojo6Ojo6Ojo+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj4+Pj5CQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkA==";

      function playBeep() {
        try {
          const audio = new Audio(BEEP_SOUND);
          audio.volume = 0.5;
          audio.play();
        } catch (e) {
          console.log("Could not play beep");
        }
      }

      // Timer Widget (counts up)
      function createTimerWidget() {
        let seconds = 0;
        let intervalId = null;
        let running = false;

        const widget = document.createElement("div");
        widget.className = "widget";
        widget.innerHTML = `
          <div class="widget-header">‚è±Ô∏è Timer</div>
          <div class="widget-display">00:00</div>
          <div class="widget-controls">
            <button class="widget-btn primary start-btn">Start</button>
            <button class="widget-btn reset-btn">Reset</button>
          </div>
        `;

        const display = widget.querySelector(".widget-display");
        const startBtn = widget.querySelector(".start-btn");
        const resetBtn = widget.querySelector(".reset-btn");

        startBtn.onclick = () => {
          if (running) {
            clearInterval(intervalId);
            startBtn.textContent = "Start";
            startBtn.classList.add("primary");
            running = false;
          } else {
            intervalId = setInterval(() => {
              seconds++;
              display.textContent = formatTime(seconds);
            }, 1000);
            startBtn.textContent = "Pause";
            startBtn.classList.remove("primary");
            running = true;
          }
        };

        resetBtn.onclick = () => {
          clearInterval(intervalId);
          seconds = 0;
          display.textContent = formatTime(seconds);
          startBtn.textContent = "Start";
          startBtn.classList.add("primary");
          running = false;
        };

        return widget;
      }

      // Countdown Widget
      function createCountdownWidget(duration, label) {
        let remaining = duration;
        let intervalId = null;
        let running = false;
        const originalDuration = duration;

        const widget = document.createElement("div");
        widget.className = "widget";
        widget.innerHTML = `
          <div class="widget-header">‚è≥ ${label || "Countdown"}</div>
          <div class="widget-display">${formatTime(remaining)}</div>
          <div class="widget-controls">
            <button class="widget-btn primary start-btn">Start</button>
            <button class="widget-btn reset-btn">Reset</button>
          </div>
        `;

        const display = widget.querySelector(".widget-display");
        const startBtn = widget.querySelector(".start-btn");
        const resetBtn = widget.querySelector(".reset-btn");

        startBtn.onclick = () => {
          if (running) {
            clearInterval(intervalId);
            startBtn.textContent = "Start";
            startBtn.classList.add("primary");
            running = false;
          } else if (remaining > 0) {
            intervalId = setInterval(() => {
              remaining--;
              display.textContent = formatTime(remaining);
              if (remaining <= 0) {
                clearInterval(intervalId);
                display.classList.add("done");
                display.textContent = "Done!";
                startBtn.textContent = "Done";
                startBtn.disabled = true;
                playBeep();
                running = false;
              }
            }, 1000);
            startBtn.textContent = "Pause";
            startBtn.classList.remove("primary");
            running = true;
          }
        };

        resetBtn.onclick = () => {
          clearInterval(intervalId);
          remaining = originalDuration;
          display.textContent = formatTime(remaining);
          display.classList.remove("done");
          startBtn.textContent = "Start";
          startBtn.classList.add("primary");
          startBtn.disabled = false;
          running = false;
        };

        return widget;
      }

      // Pomodoro Widget
      function createPomodoroWidget() {
        const WORK_TIME = 25 * 60; // 25 minutes
        const BREAK_TIME = 5 * 60; // 5 minutes
        let remaining = WORK_TIME;
        let isWork = true;
        let intervalId = null;
        let running = false;
        let cycles = 0;

        const widget = document.createElement("div");
        widget.className = "widget";
        widget.innerHTML = `
          <div class="widget-header">üçÖ Pomodoro</div>
          <div class="widget-display">${formatTime(remaining)}</div>
          <div class="widget-status">Work Session</div>
          <div class="widget-controls">
            <button class="widget-btn primary start-btn">Start</button>
            <button class="widget-btn skip-btn">Skip</button>
            <button class="widget-btn reset-btn">Reset</button>
          </div>
        `;

        const display = widget.querySelector(".widget-display");
        const status = widget.querySelector(".widget-status");
        const startBtn = widget.querySelector(".start-btn");
        const skipBtn = widget.querySelector(".skip-btn");
        const resetBtn = widget.querySelector(".reset-btn");

        function switchMode() {
          isWork = !isWork;
          remaining = isWork ? WORK_TIME : BREAK_TIME;
          if (!isWork) cycles++;
          status.textContent = isWork ? "Work Session" : `Break Time (${cycles} completed)`;
          display.textContent = formatTime(remaining);
          display.classList.remove("done");
          playBeep();
        }

        startBtn.onclick = () => {
          if (running) {
            clearInterval(intervalId);
            startBtn.textContent = "Start";
            startBtn.classList.add("primary");
            running = false;
          } else {
            intervalId = setInterval(() => {
              remaining--;
              display.textContent = formatTime(remaining);
              if (remaining <= 0) {
                clearInterval(intervalId);
                running = false;
                switchMode();
                startBtn.textContent = "Start";
                startBtn.classList.add("primary");
              }
            }, 1000);
            startBtn.textContent = "Pause";
            startBtn.classList.remove("primary");
            running = true;
          }
        };

        skipBtn.onclick = () => {
          clearInterval(intervalId);
          running = false;
          switchMode();
          startBtn.textContent = "Start";
          startBtn.classList.add("primary");
        };

        resetBtn.onclick = () => {
          clearInterval(intervalId);
          isWork = true;
          remaining = WORK_TIME;
          cycles = 0;
          status.textContent = "Work Session";
          display.textContent = formatTime(remaining);
          display.classList.remove("done");
          startBtn.textContent = "Start";
          startBtn.classList.add("primary");
          running = false;
        };

        return widget;
      }

      // Listen for widget events from main process
      ipcRenderer.on("render-widget", (event, data) => {
        if (emptyState && emptyState.parentNode) {
          emptyState.remove();
        }

        let widget;
        switch (data.type) {
          case "timer":
            widget = createTimerWidget();
            break;
          case "countdown":
            widget = createCountdownWidget(data.duration || 60, data.label);
            break;
          case "pomodoro":
            widget = createPomodoroWidget();
            break;
        }

        if (widget) {
          chatContainer.appendChild(widget);
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
      });
    </script>
  </body>
</html>
